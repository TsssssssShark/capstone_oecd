---
title: "Data Report"
date: today
author: Yichu Li
format: 
   pdf:
    toc: true
    number-sections: true
execute:
  echo: false
  warning: true
  message: false
  cache: false
---

## Script Info

**Project:** OECD National Evaluation Portal\
**Purpose:** (1) To explore 2023 Survey Responses on central web portal, (2) to present findings in the portal assessment table.

```{r}
#| label: setup-packages
#| include: false

# Check and install required packages
required_packages <- c(
  'tidyverse',
  'jsonlite',
  'kableExtra',
  'here',
  'glue',
  'officer',
  'flextable',
  'gt'
)

missing_packages <- required_packages[
  !required_packages %in% rownames(installed.packages())
]

if (length(missing_packages) > 0) {
  message(
    "Installing missing packages:",
    paste(missing_packages, collapse = ", "),
    "\n"
  )
  install.packages(missing_packages)
}

lapply(required_packages, library, character.only = TRUE)

message('All packages loaded successfully!')
```

## Input Data Sets

```{r}
#| label: setup-directories

# Input
original_data = here::here('OECD.GOV.GIP,DSD_QDD_GOV_PE@DF_GOV_PE,+all.csv')
portal_assessment = here::here('portal_assessment.csv')

# Output
js_output_dir = here::here('map', 'js')
fig_output_dir = here::here('fig')

message(basename(original_data))
message(basename(portal_assessment))
```

```{r}
#| label: data-load
#| include: false

df <- read_csv(original_data)

new_data <- read_csv(portal_assessment)


```

\newpage

## 2023 Survey Data Exploration

```{r}
#| label: data-exploration

df %>%
  summarise_all(~paste(unique(na.omit(.)), collapse = ", ")) %>%
  pivot_longer(everything(), names_to = "Column", values_to = "Unique_Values") %>%
  mutate(
    Count = sapply(str_split(Unique_Values, ", "), length),
    Unique_Values = str_trunc(Unique_Values, 50)  # cut short
  ) %>%
  kable(caption = "Unique Values per Column")
```

### Re-format Data

Only keep relevant columns for 2023 survey

```{r}
#| label: data-reformat-original
#| eval: true

# Rename and keep relavant columns
df <- df %>%
  select(
    country = `Reference area`,
    survey_question = Measure,
    survey_answer = OBS_VALUE
  )
  
df %>%
  summarise_all(~paste(unique(na.omit(.)), collapse = ", ")) %>%
  pivot_longer(everything(), names_to = "Column", values_to = "Unique_Values") %>%
  mutate(
    Count = sapply(str_split(Unique_Values, ", "), length),
    Unique_Values = str_trunc(Unique_Values, 50)  # cut short
  ) %>%
  kable(caption = "Unique Values per Column")
```

\newpage

## Portal Assessment Table Findings:

### Update on Central Web Portal Status

```{r}
#| label: new-data-pivot-longer

new_data <- new_data %>%
  select(-'...33')

new_data_long <- new_data %>%
  pivot_longer(
    cols = -1,
    names_to = 'country',
    values_to = 'survey_answer'
  ) %>%
  rename(survey_question = 1) %>%
  filter(!is.na(country))

# Display new list of countries
unique_new_countries <- unique(new_data_long$country)

# Add row numbers for grouping
data.frame(
  country = unique_new_countries,
  row = rep(1:ceiling(length(unique_new_countries)/4), each = 4)[1:length(unique_new_countries)],
  col = rep(1:4, times = ceiling(length(unique_new_countries)/4))[1:length(unique_new_countries)]
) %>%
  pivot_wider(
    names_from = col,
    values_from = country,
    names_prefix = "Col_"
  ) %>%
  select(-row) %>%
  kable(
    format = "latex",
    booktabs = TRUE,
    caption = "New Country List",
    col.names = rep("", 4),
    align = rep("l", 4)
  ) %>%
  kable_styling(
    latex_options = "hold_position",
    full_width = FALSE
  ) %>%
  column_spec(1:4, width = "3.5cm")
```

\newpage

#### How does the 2023 survey response compare to our updated information?

```{r}
#| label: q-34

df_q34 <- df %>%
  filter(
    survey_question == '34. Is there a central web portal where government evaluations are published?'
    ) %>%
      arrange(country) %>%
      select(country, original_answer = survey_answer)

new_data_q34 <- new_data_long %>%
  filter(survey_question == '3.12 Central portal exists') %>%
  arrange(country) %>%
  select(country, update_answer = survey_answer)

# Comparative Display
comparison <- full_join(df_q34, new_data_q34, by = 'country') %>%
  mutate(
    # Ignore capital but treat NA as value
    changed = case_when(
      is.na(original_answer) & is.na(update_answer) ~ FALSE,
      is.na(original_answer) | is.na(update_answer) ~ TRUE, 
      TRUE ~ tolower(original_answer) != tolower(update_answer)
    )
  )

# Different color
comparison %>%
  select(-changed) %>%
  kable(
    format = "latex",
    booktabs = TRUE,
    caption = "Central Portal Exists?",
    col.names = c("Country", "2023 survey", "Update")
  ) %>%
  kable_styling(
    latex_options = c("scale_down", "hold_position")
  ) %>%
  row_spec(
    which(comparison$changed),
    background = "red!20" 
  )
```

```{r}
#| label: export-q34-comparison-png
#| eval: true

# Export to .png
ft_q34 <- comparison %>%
  select(country, original_answer, update_answer) %>%
  flextable() %>%
  
  # Set column headers
  set_header_labels(
    country = "Country",
    original_answer = "2023 Survey",
    update_answer = "Update"
  ) %>%
  
  # Highlight changed rows
  bg(i = which(comparison$changed), 
     bg = "#4682C8") %>% 
  
   # Increase font size for all cells
  fontsize(size = 12, part = "all") %>%
  
  # Make header bold and larger
  bold(part = "header") %>%
  
  # Auto-adjust column widths
  autofit() %>%
  
  # Add outer border
  border_outer(border = fp_border(color = "black"))

# Save as image
save_as_image(ft_q34, path = glue("{fig_output_dir}/portal_status_comparison.png"), res = 300)
```

\newpage

#### Re-format update data on [central portal]{.underline}

Correct the status for Hungary and Lithuania to 'developing'

```{r}
#| label: central-portal-status

# Correct status for Hungary and Lithunia
new_data_q34 <- new_data_q34 %>%
  mutate(
    update_answer = case_when(
      country == 'Hungary' ~ 'under development',
      country == 'Lithuania' ~ 'under development',
      TRUE ~ update_answer
    )
  )

# Denote status to all countries
central_portal_status <- new_data_q34 %>%
  mutate(
    portal_status = case_when(
      # Convert to lowercase and check for patterns
      grepl("yes", tolower(trimws(update_answer))) ~ "yes",
     grepl("no", tolower(trimws(update_answer))) & 
        !grepl("under development|in development", tolower(update_answer)) ~ "no",
      grepl("under development|in development|currently under", 
            tolower(update_answer)) ~ "developing",
      is.na(update_answer) ~ "developing",
      TRUE ~ "other"
    )
  ) %>%
  select(country, portal_status)

# Split data into two columns
n_rows <- nrow(central_portal_status)
split_point <- ceiling(n_rows / 2)

# Create left and right columns
left_col <- central_portal_status[1:split_point, ]
right_col <- central_portal_status[(split_point + 1):n_rows, ]

# Pad right column with empty rows if needed
if (nrow(right_col) < nrow(left_col)) {
  right_col <- bind_rows(
    right_col,
    data.frame(
      country = rep("", nrow(left_col) - nrow(right_col)),
      portal_status = rep("", nrow(left_col) - nrow(right_col))
    )
  )
}

# Apply colors before combining using cell_spec
left_col_formatted <- left_col %>%
  mutate(
    portal_status = cell_spec(
      portal_status,
      format = "latex",
      background = case_when(
        portal_status == "yes" ~ "blue!20",
        portal_status == "no" ~ "red!20",
        TRUE ~ "white"
      )
    )
  )

right_col_formatted <- right_col %>%
  mutate(
    portal_status = cell_spec(
      portal_status,
      format = "latex",
      background = case_when(
        portal_status == "yes" ~ "blue!20",
        portal_status == "no" ~ "red!20",
        TRUE ~ "white"
      )
    )
  )

# Combine into single table
two_col_table <- bind_cols(
  left_col_formatted,
  right_col_formatted %>% setNames(c("country2", "portal_status2"))
)

# Create table
two_col_table %>%
  kable(
    format = "latex",
    booktabs = TRUE,
    caption = "Portal Status Distribution",
    col.names = c("Country", "Status", "Country", "Status"),
    escape = FALSE  # Important for cell_spec to work
  ) %>%
  kable_styling(
    latex_options = c("hold_position"),
    full_width = FALSE,
    position = "center"
  ) %>%
  column_spec(2, border_right = TRUE) %>%
  column_spec(1, width = "4cm") %>%
  column_spec(2, width = "2.5cm") %>%
  column_spec(3, width = "4cm") %>%
  column_spec(4, width = "2.5cm")
```

```{r}
#| label: export-portal-png

# Create two-column layout WITHOUT LaTeX formatting
two_col_display <- bind_cols(
  left_col,  # Use original data, not formatted
  right_col %>% setNames(c("country2", "portal_status2"))
)

# Define colors - using the blue from LaTeX header and complementary orange
blue_color <- "#4682C8"   
orange_color <- "#FF8C00"   
grey_color <- "grey"   

# Create flextable with proper formatting
ft <- two_col_display %>%
  flextable() %>%
  # Set column headers
  set_header_labels(
    country = "Country",
    portal_status = "Status",
    country2 = "Country",
    portal_status2 = "Status"
  ) %>%
  # Apply background colors to left column status cells
  bg(i = which(left_col$portal_status == "yes"), 
     j = 2,  # Status column (left)
     bg = blue_color) %>%  
  bg(i = which(left_col$portal_status == "no"), 
     j = 2, 
     bg = orange_color) %>%  
  bg(i = which(left_col$portal_status == "developing"), 
     j = 2, 
     bg = grey_color) %>%  
  # Apply background colors to right column status cells
  bg(i = which(right_col$portal_status == "yes"), 
     j = 4,  # Status column (right)
     bg = blue_color) %>%
  bg(i = which(right_col$portal_status == "no"), 
     j = 4, 
     bg = orange_color) %>%
  bg(i = which(right_col$portal_status == "developing"), 
     j = 4, 
     bg = grey_color) %>%
  # Remove empty rows from coloring (if any)
  bg(i = which(right_col$portal_status == ""), 
     j = 4, 
     bg = "white") %>%
  # Text color - white for better contrast on dark backgrounds
  color(i = which(left_col$portal_status %in% c("yes", "no")), 
        j = 2, 
        color = "white") %>%
  color(i = which(right_col$portal_status %in% c("yes", "no")), 
        j = 4, 
        color = "white") %>%
  # Style the table
  bold(part = "header") %>%
  align(align = "center", j = c(2, 4), part = "all") %>%  # Center status columns
  align(align = "left", j = c(1, 3), part = "all") %>%    # Left align country names
  border_inner_v(border = fp_border(color = "gray", width = 1)) %>%
  border_outer(border = fp_border(color = "black", width = 2)) %>%
  # Set column widths
  width(j = c(1, 3), width = 2.5) %>%  # Country columns
  width(j = c(2, 4), width = 1.2) %>%   # Status columns
  fontsize(size = 11, part = "all") %>%
  font(fontname = "Arial", part = "all")

# Save as image
save_as_image(ft, 
              path = file.path(fig_output_dir, "portal_status_table.png"), 
              res = 300)

message("Table saved to: ", file.path(fig_output_dir, "portal_status_table.png"))
```

```{r}
#| label: export-portal-js

tryCatch({
map_data <- central_portal_status %>%
  mutate(
    color = case_when(
      portal_status == "yes" ~ "#5cb85c",     
      portal_status == "no" ~ "#dc3545",      
      portal_status == "developing" ~ "#ffc107",
      TRUE ~ "#6c757d"                    
    ),
    label = case_when(
      portal_status == "yes" ~ "Has Portal",
      portal_status == "no" ~ "No Portal",
      portal_status == "developing" ~ "Under Development",
      TRUE ~ "Unknown"
    )
  )

# Generate JS with additional properties
js_content <- paste0(
  "// Portal status with map styling\n",
  "// Generated: ", Sys.Date(), "\n\n",
  "const PORTAL_MAP_DATA = ",
  jsonlite::toJSON(map_data, pretty = TRUE, auto_unbox = TRUE),
  ";\n\n",
  "// Color mapping for legend\n",
  "const STATUS_COLORS = {\n",
  "  'yes': '#28a745',\n",
  "  'no': '#dc3545',\n",
  "  'developing': '#ffc107',\n",
  "  'other': '#6c757d'\n",
  "};\n\n",
  "// Export\n",
  "if (typeof module !== 'undefined' && module.exports) {\n",
  "  module.exports = { PORTAL_MAP_DATA, STATUS_COLORS };\n",
  "}"
)

writeLines(js_content, file.path(js_output_dir, "portalMapData.js"))

message('Javascript exported to map/js/portalMapData.js')

}, error = function(e) {
  message('Error in JavaScript export: ', e$message)
  print(e)
})
```
