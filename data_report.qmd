---
title: "Data Report"
date: today
author: Yichu Li
format: 
   pdf:
    toc: true
    number-sections: true
    text: |
        \usepackage{colortbl}
        \usepackage{xcolor}
        \usepackage{booktabs}
execute:
  echo: false
  warning: true
  message: false
  cache: false
---

## Script Info

**Project:** OECD National Evaluation Portal\
**Purpose:** (1) To explore 2023 Survey Responses on central web portal, (2) to present findings in the portal assessment table.

```{r}
#| label: setup-packages
#| include: false

# Check and install required packages
required_packages <- c(
  'tidyverse',
  'jsonlite',
  'kableExtra',
  'here',
  'glue',
  'officer',
  'flextable',
  'gt',
  'ggplot2'
)

missing_packages <- required_packages[
  !required_packages %in% rownames(installed.packages())
]

if (length(missing_packages) > 0) {
  message(
    "Installing missing packages:",
    paste(missing_packages, collapse = ", "),
    "\n"
  )
  install.packages(missing_packages)
}

lapply(required_packages, library, character.only = TRUE)

message('All packages loaded successfully!')
```

## Input Data Sets

```{r}
#| label: setup-directories

# Input
original_data = here::here('OECD.GOV.GIP,DSD_QDD_GOV_PE@DF_GOV_PE,+all.csv')
portal_assessment = here::here('portal_assessment.csv')

# Output
js_output_dir = here::here('map', 'js')
fig_output_dir = here::here('fig')
table_output_dir = here::here('tab')

message(basename(original_data))
message(basename(portal_assessment))
```

```{r}
#| label: data-load
#| include: false

df <- read_csv(original_data)

new_data <- read_csv(portal_assessment)


```

\newpage

## 2023 Survey Data Exploration

```{r}
#| label: data-exploration

df %>%
  summarise_all(~paste(unique(na.omit(.)), collapse = ", ")) %>%
  pivot_longer(everything(), names_to = "Column", values_to = "Unique_Values") %>%
  mutate(
    Count = sapply(str_split(Unique_Values, ", "), length),
    Unique_Values = str_trunc(Unique_Values, 50)  # cut short
  ) %>%
  kable(caption = "Unique Values per Column")
```

### Re-format Data

Only keep relevant columns for 2023 survey

```{r}
#| label: data-reformat-original
#| eval: true

# Rename and keep relavant columns
df <- df %>%
  select(
    country = `Reference area`,
    survey_question = Measure,
    survey_answer = OBS_VALUE
  )
  
df %>%
  summarise_all(~paste(unique(na.omit(.)), collapse = ", ")) %>%
  pivot_longer(everything(), names_to = "Column", values_to = "Unique_Values") %>%
  mutate(
    Count = sapply(str_split(Unique_Values, ", "), length),
    Unique_Values = str_trunc(Unique_Values, 50)  # cut short
  ) %>%
  kable(caption = "Unique Values per Column")
```

\newpage

## Accessibility:

### Update on Central Web Portal Status

```{r}
#| label: new-data-pivot-longer

new_data <- new_data %>%
  select(-'...33')

new_data_long <- new_data %>%
  pivot_longer(
    cols = -1,
    names_to = 'country',
    values_to = 'survey_answer'
  ) %>%
  rename(survey_question = 1) %>%
  filter(!is.na(country))

# Display new list of countries
unique_new_countries <- unique(new_data_long$country)

# Add row numbers for grouping
data.frame(
  country = unique_new_countries,
  row = rep(1:ceiling(length(unique_new_countries)/4), each = 4)[1:length(unique_new_countries)],
  col = rep(1:4, times = ceiling(length(unique_new_countries)/4))[1:length(unique_new_countries)]
) %>%
  pivot_wider(
    names_from = col,
    values_from = country,
    names_prefix = "Col_"
  ) %>%
  select(-row) %>%
  kable(
    format = "latex",
    booktabs = TRUE,
    caption = "New Country List",
    col.names = rep("", 4),
    align = rep("l", 4)
  ) %>%
  kable_styling(
    latex_options = "hold_position",
    full_width = FALSE
  ) %>%
  column_spec(1:4, width = "3.5cm")
```

\newpage

#### How does the 2023 survey response compare to our updated information?

```{r}
#| label: q-34


df_q34 <- df %>%
  filter(
    survey_question == '34. Is there a central web portal where government evaluations are published?'
    ) %>%
      arrange(country) %>%
      select(country, original_answer = survey_answer)

new_data_q34 <- new_data_long %>%
  filter(survey_question == '3.12 Central portal exists') %>%
  arrange(country) %>%
  select(country, update_answer = survey_answer)

# Comparative Display
comparison <- full_join(df_q34, new_data_q34, by = 'country') %>%
  mutate(
    # Replace NA
    original_str = replace_na(original_answer, "NA"),
    update_str = case_when(
      grepl('yes', tolower(update_answer)) ~ 'Yes',
      TRUE ~ 'No'
    ),
   
    # Comparison 
    status = case_when(
      original_str == "NA" ~ 'new_countries',
      
      grepl('development', tolower(original_str)) &
        !grepl('yes', tolower(update_str)) ~ 'development',
      
      grepl('no|development', tolower(original_str)) &
        grepl('yes', tolower(update_str)) ~ 'developed',
      
      grepl('yes', tolower(original_str)) &
        grepl('no', tolower(update_str)) ~ 'removed',
      
      TRUE ~ 'unchanged'
    )
  )

# Different color
comparison_table <- comparison %>%
  select(country, original_str, update_str) %>%
  kable(
    format = "latex",
    booktabs = TRUE,
    caption = "Central Portal Status Comparison",
    label = 'portal_comparison_table',
    col.names = c("Country", "2023 survey", "Update")
  ) %>%
  row_spec(
    which(comparison$status == 'developed'),
    background = "blue!20" 
  ) %>%
  row_spec(
    which(comparison$status == 'removed'),
    background = 'red!20'
  ) %>% 
  row_spec(
    which(comparison$status == 'development'),
    background = 'orange!20'
  ) %>%
  row_spec(
    which(comparison$status == 'new_countries'),
    background = 'green!20'
  )

# Show and Export table
comparison_table

if (dir.exists(table_output_dir)) {
  writeLines(as.character(comparison_table), 
   file.path(table_output_dir, "portal_comparison_table.tex"))
  
} else {
  stop(glue('Directory not found: {table_output_dir}'))
}
```

\newpage

#### Re-format update data on [central portal]{.underline}

Correct the status for Hungary to 'developing'

```{r}
#| label: central-portal-status

# Correct status for Hungary and Lithunia
new_data_q34 <- new_data_q34 %>%
  mutate(
    update_answer = case_when(
      country == 'Hungary' ~ 'under development',
      TRUE ~ update_answer
    )
  )

# Denote status to all countries
central_portal_status <- new_data_q34 %>%
  mutate(
    portal_status = case_when(
      # Convert to lowercase and check for patterns
      grepl("yes", tolower(trimws(update_answer))) ~ "yes",
     grepl("no", tolower(trimws(update_answer))) & 
        !grepl("under development|in development", tolower(update_answer)) ~ "no",
      grepl("under development|in development|currently under", 
            tolower(update_answer)) ~ "developing",
      is.na(update_answer) ~ "developing",
      TRUE ~ "other"
    )
  ) %>%
  select(country, portal_status)
```

```{r}
#| label: function-split-table

create_split_table <- function(data,
                              value_col = "status",
                              group_col = "country", 
                              color_map = NULL,
                              caption = "Two Column Table",
                              col_names = c("Country", "Status", "Country", "Status"),
                              col_widths = c("4cm", "2.5cm", "4cm", "2.5cm"),
                              export_tex = FALSE,
                              tex_filename = NULL,
                              tex_label = NULL) {
  
  # Split data into two columns
  n_rows <- nrow(data)
  split_point <- ceiling(n_rows / 2)
  
  # Create left and right columns
  left_col <- data[1:split_point, ]
  
  # Handle right column
  if(split_point < n_rows) {
    right_col <- data[(split_point + 1):n_rows, ]
  } else {
    right_col <- data.frame(
      matrix("", nrow = 0, ncol = ncol(data))
    )
    names(right_col) <- names(data)
  }
  
  # Pad right column with empty rows if needed
  if (nrow(right_col) < nrow(left_col)) {
    padding_rows <- nrow(left_col) - nrow(right_col)
    padding <- data.frame(
      matrix("", nrow = padding_rows, ncol = ncol(data))
    )
    names(padding) <- names(data)
    right_col <- bind_rows(right_col, padding)
  }
  
  # Apply LaTeX color formatting if color_map provided
  if (!is.null(color_map)) {
    # Apply LaTeX color formatting to left column
    left_col_formatted <- left_col %>%
      mutate(
        !!value_col := ifelse(
          .data[[value_col]] == "",
          "",
          cell_spec(
            .data[[value_col]],
            format = "latex",
            background = ifelse(
              .data[[value_col]] %in% names(color_map),
              color_map[.data[[value_col]]],
              "white"
            )
          )
        )
      )
    
    # Apply LaTeX color formatting to right column
    right_col_formatted <- right_col %>%
      mutate(
        !!value_col := ifelse(
          .data[[value_col]] == "",
          "",
          cell_spec(
            .data[[value_col]],
            format = "latex",
            background = ifelse(
              .data[[value_col]] %in% names(color_map),
              color_map[.data[[value_col]]],
              "white"
            )
          )
        )
      )
  } else {
    left_col_formatted <- left_col
    right_col_formatted <- right_col
  }
  
  # Combine into single table
  two_col_table <- bind_cols(
    left_col_formatted,
    right_col_formatted %>% 
      setNames(paste0(names(right_col_formatted), "2"))
  )
  
  # Create kable table
  result <- two_col_table %>%
    kable(
      format = "latex",
      booktabs = TRUE,
      caption = caption,
      label = tex_label,
      col.names = col_names,
      escape = FALSE
    ) %>%
    kable_styling(
      latex_options = c("hold_position"),
      full_width = FALSE,
      position = "center"
    ) %>%
    column_spec(2, border_right = TRUE)
  
  # Apply column widths
  for(i in 1:length(col_widths)) {
    result <- result %>% column_spec(i, width = col_widths[i])
  }
  
  # Export to .tex file
  if (export_tex && !is.null(tex_filename)) {
    if (!exists("table_output_dir")) {
      stop("table_output_dir undefined!")
    }
    
    tex_path <- file.path(table_output_dir, tex_filename)
    
    writeLines(as.character(result), tex_path)
  }
  
  return(result)
}
```

```{r}
#| label: central-portal-table

portal_table <- create_split_table(
  data = central_portal_status,
  value_col = "portal_status",
  group_col = "country",
  color_map = c(
    "yes" = "blue!20", 
    "no" = "red!20",
    "developing" = "gray!20"
  ),
  caption = "Updated Portal Status",
  export_tex = TRUE,
  tex_filename = 'portal_table.tex',
  tex_label = 'portal_table'
)

portal_table
```

```{r}
#| label: export-portal-js

tryCatch({
map_data <- central_portal_status %>%
  mutate(
    color = case_when(
      portal_status == "yes" ~ "#5cb85c",     
      portal_status == "no" ~ "#dc3545",      
      portal_status == "developing" ~ "#ffc107",
      TRUE ~ "#6c757d"                    
    ),
    label = case_when(
      portal_status == "yes" ~ "Has Portal",
      portal_status == "no" ~ "No Portal",
      portal_status == "developing" ~ "Under Development",
      TRUE ~ "Unknown"
    )
  )

# Generate JS with additional properties
js_content <- paste0(
  "// Portal status with map styling\n",
  "// Generated: ", Sys.Date(), "\n\n",
  "const PORTAL_MAP_DATA = ",
  jsonlite::toJSON(map_data, pretty = TRUE, auto_unbox = TRUE),
  ";\n\n",
  "// Color mapping for legend\n",
  "const STATUS_COLORS = {\n",
  "  'yes': '#28a745',\n",
  "  'no': '#dc3545',\n",
  "  'developing': '#ffc107',\n",
  "  'other': '#6c757d'\n",
  "};\n\n",
  "// Export\n",
  "if (typeof module !== 'undefined' && module.exports) {\n",
  "  module.exports = { PORTAL_MAP_DATA, STATUS_COLORS };\n",
  "}"
)

if (dir.exists(js_output_dir)) {
  writeLines(js_content, file.path(js_output_dir, "portalMapData.js"))
} else {
  stop(glue('JavaScript output directory not found: {js_output_dir}'))
}

}, error = function(e) {
  message('Error in JavaScript export: ', e$message)
  print(e)
})
```

\newpage

### Independent website or a sub-tab of another website?

```{r}
#| label: independent-website-table

# Create df
independent_website_data <- new_data_long %>%
  filter(survey_question == '3.14 Independent website rather than subtab of another website?') %>%
  mutate(
    independent_website = case_when(
      grepl("yes", tolower(trimws(survey_answer))) ~ "yes",
      grepl('no', tolower(trimws(survey_answer))) ~ 'no',
      TRUE ~ 'NA'
    )
  ) %>%
  select(country, independent_website) %>%
  arrange(country)

# Creat table
independent_website_table <- create_split_table(
  data = independent_website_data,
  value_col = "independent_website",
  group_col = "country",
  color_map = c(
    "yes" = "blue!20", 
    "no" = "red!20"
  ),
  caption = "Independent Portal?",
  export_tex = TRUE,
  tex_filename = 'independent_website_table',
  tex_label = 'independent_website_table'
)

independent_website_table
```

\newpage

### Search Function

```{r}
#| label: search-function-table

# Create df
search_function_df <- new_data_long %>%
  filter(survey_question == '3.1 Search function') %>%
  mutate(
    search_function = case_when(
      grepl("yes", tolower(trimws(survey_answer))) ~ "yes",
      grepl('no', tolower(trimws(survey_answer))) ~ 'no',
      TRUE ~ 'NA'
    )
  ) %>%
  select(country, search_function) %>%
  arrange(country)

# Create table
search_function_table <- create_split_table(
  data = search_function_df,
  value_col = "search_function",
  group_col = "country",
  color_map = c(
    "yes" = "blue!20", 
    "no" = "red!20"
  ),
  caption = "Search Function?",
  export_tex = TRUE,
  tex_filename = 'search_function_table.tex',
  tex_label = 'search_function_table'
)

search_function_table
```

\newpage

### Policy Area Categorisation?

```{r}
#| label: policy-categorisation-table

# Create df
policy_categorisation_data <- new_data_long %>%
  filter(survey_question == '3.2 Policy area categorisation') %>%
  mutate(
    policy_categorisation = case_when(
      grepl("yes", tolower(trimws(survey_answer))) ~ "yes",
      grepl('no', tolower(trimws(survey_answer))) ~ 'no',
      TRUE ~ 'NA'
    )
  ) %>%
  select(country, policy_categorisation) %>%
  arrange(country)

# Creat table
policy_categorisation_table <- create_split_table(
  data = policy_categorisation_data,
  value_col = "policy_categorisation",
  group_col = "country",
  color_map = c(
    "yes" = "blue!20", 
    "no" = "red!20"
  ),
  caption = "Policy Area Categorisation?",
  export_tex = TRUE,
  tex_filename = 'policy_categorisation_table.tex',
  tex_label = 'policy_categorisation_table'
)

policy_categorisation_table
```

\newpage

### Summary Available on the Portal?

```{r}
#| label: summary-available-table


# Create df
summary_available_data <- new_data_long %>%
  filter(survey_question == '3.11 Summaries available on the portal (not as a part of the main documents)') %>%
  mutate(
    summary_available = case_when(
      grepl("yes", tolower(trimws(survey_answer))) ~ "yes",
      grepl('no', tolower(trimws(survey_answer))) ~ 'no',
      TRUE ~ 'NA'
    )
  ) %>%
  select(country, summary_available) %>%
  arrange(country)

# Creat table
summary_available_table <- create_split_table(
  data = summary_available_data,
  value_col = "summary_available",
  group_col = "country",
  color_map = c(
    "yes" = "blue!20", 
    "no" = "red!20"
  ),
  caption = "Summary Available on the Portal",
  export_tex = TRUE,
  tex_filename = 'summary_available_table.tex',
  tex_label = 'summary_available_table'
)

summary_available_table
```

\newpage

### Accessibility Tools

```{r}
#| label: accessibility-tools-table

# Create df
accessibility_tools_df <- new_data_long %>%
  filter(survey_question == '3.3 Accessibility tools') %>%
  mutate(
    accessibility_tools = case_when(
      grepl("yes", tolower(trimws(survey_answer))) ~ "yes",
      grepl('no', tolower(trimws(survey_answer))) ~ 'no',
      TRUE ~ 'NA'
    )
  ) %>%
  select(country, accessibility_tools) %>%
  arrange(country)

# Create table
accessibility_tools_table <- create_split_table(
  data = accessibility_tools_df,
  value_col = "accessibility_tools",
  group_col = "country",
  color_map = c(
    "yes" = "blue!20", 
    "no" = "red!20"
  ),
  caption = "Accessibility Tools?",
  export_tex = TRUE,
  tex_filename = 'accessibility_tools_table.tex',
  tex_label = 'accessibility_tools_table'
)

accessibility_tools_table
```

\newpage

### Visual Presentation

```{r}
#| label: visual-presentation-table

# Create df
visual_presentation_df <- new_data_long %>%
  filter(survey_question == '3.8 Visual presentation (graphs/diagrams)') %>%
  mutate(
    visual_presentation = case_when(
      grepl("yes", tolower(trimws(survey_answer))) ~ "yes",
      grepl('no', tolower(trimws(survey_answer))) ~ 'no',
      TRUE ~ 'NA'
    )
  ) %>%
  select(country, visual_presentation) %>%
  arrange(country)

# Create table
visual_presentation_table <- create_split_table(
  data = visual_presentation_df,
  value_col = "visual_presentation",
  group_col = "country",
  color_map = c(
    "yes" = "blue!20", 
    "no" = "red!20"
  ),
  caption = "Visual Presentation?",
  export_tex = TRUE,
  tex_filename = 'visual_presentation_table.tex',
  tex_label = 'visual_presentation_table'
)

visual_presentation_table
```

\newpage

### Comfortable Font

```{r}
#| label: comfortable-font-table

# Create df
comfortable_font_df <- new_data_long %>%
  filter(survey_question == '3.6 Comfortable font') %>%
  mutate(
    comfortable_font = case_when(
      grepl("yes", tolower(trimws(survey_answer))) ~ "yes",
      grepl('no', tolower(trimws(survey_answer))) ~ 'no',
      TRUE ~ 'NA'
    )
  ) %>%
  select(country, comfortable_font) %>%
  arrange(country)

# Create table
comfortable_font_table <- create_split_table(
  data = comfortable_font_df,
  value_col = "comfortable_font",
  group_col = "country",
  color_map = c(
    "yes" = "blue!20", 
    "no" = "red!20"
  ),
  caption = "Comfortable Font?",
  export_tex = TRUE,
  tex_filename = 'comfortable_font_table.tex',
  tex_label = 'comfortable_font_table'
)

comfortable_font_table
```

\newpage

### Interactive Tools

```{r}
#| label: interactive-tools-table

# Create df
interactive_tools_df <- new_data_long %>%
  filter(survey_question == '3.9 Interactive tools') %>%
  mutate(
    interactive_tools = case_when(
      grepl("yes", tolower(trimws(survey_answer))) ~ "yes",
      grepl('no', tolower(trimws(survey_answer))) ~ 'no',
      TRUE ~ 'NA'
    )
  ) %>%
  select(country, interactive_tools) %>%
  arrange(country)

# Create table
interactive_tools_table <- create_split_table(
  data = interactive_tools_df,
  value_col = "interactive_tools",
  group_col = "country",
  color_map = c(
    "yes" = "blue!20", 
    "no" = "red!20"
  ),
  caption = "Interactive Tools?",
  export_tex = TRUE,
  tex_filename = 'interactive_tools_table.tex',
  tex_label = 'interactive_tools_table'
)

interactive_tools_table
```

\newpage

## Comprehensiveness:

### COFOG Categories (10) Coverage

```{r}
#| label: cofog-data

cofog <- new_data_long %>%
  filter(survey_question == '2.1 Number of policy areas covered (out of 10 COFOG categories)') %>%
  arrange(country) %>%
  select(country, coverage = survey_answer) %>%
  mutate(
    coverage = parse_number(coverage)
  )
```

```{r}
#| label: cofog-table
#| eval: false

cofog_table <- create_split_table(
  data = cofog,
  value_col = "coverage",
  group_col = "country",
  caption = "Number of COFOG categories covered",
  export_tex = TRUE,
  tex_filename = 'cofog_table.tex',
  tex_label = 'cofog_table'
)

cofog_table
```

```{r}
#| label: cofog-bar
#| fig-cap: 'COFOG COverage by Country'
#| fig-width: 15
#| fig-height: 16

# Prepare data to treat NA
cofog_bar_data <- cofog %>%
  mutate(
    coverage_raw = coverage,
    coverage = replace_na(coverage_raw, 0),
    label_text = ifelse(is.na(coverage_raw), 'NA', as.character(coverage))
  ) %>%
  arrange(desc(coverage), country)

# Horizontal pie chart
cofog_bar_chart <- ggplot(cofog_bar_data, aes(x = coverage, y = reorder(country, coverage))) +
  geom_bar(stat = "identity", fill = "#4682C8", width = 0.6, linewidth = 0.2) +
  geom_text(
    aes(label = label_text),
    hjust = -0.2,
    size = 8,
    fontface = ifelse(cofog_bar_data$label_text == "NA", "italic", "plain") 
  ) +  
  scale_x_continuous(
    limits = c(0, 11),
    breaks = seq(0, 10, 2),
    expand = c(0, 0)
  ) +
  labs(
    x = "Number of COFOG Categories Covered (out of 10)",
    y = ""
  ) +
  theme_minimal() +
  theme(
    panel.grid.major.y = element_blank(),
    panel.grid.minor.x = element_blank(),
    axis.text.y = element_text(size = 20, face = 'bold'),
    axis.text.x = element_text(size = 20, face = 'bold'),
    axis.title.x = element_text(size = 20, face = 'bold')
  )

cofog_bar_chart

# Save chart
ggsave(
  filename = file.path(fig_output_dir, "cofog_bar.png"),
  plot = cofog_bar_chart,
  width = 10,
  height = 12,
  dpi = 300
)
```

\newpage

### Years Coverage

```{r}
#| label: years-coverage-data

oldest_year_df <- new_data_long %>%
  filter(survey_question == '1.1 Oldest year') %>%
  select(country, oldest_year = survey_answer)

latest_year_df <- new_data_long %>%
  filter(survey_question == '1.2 Latest year') %>%
  select(country, latest_year = survey_answer)

years_coverage_df <- oldest_year_df %>%
  left_join(latest_year_df, by = 'country') %>%
  mutate(
    oldest_year = as.numeric(oldest_year),
    latest_year = as.numeric(latest_year),
    coverage = as.numeric(latest_year - oldest_year),
    coverage_text = ifelse(is.na(coverage), 'NA', as.character(coverage))
  )
```

```{r}
#| label: years-coverage-chart
#| fig-cap: 'Years Coverage by Country'
#| fig-width: 15
#| fig-height: 16

years_coverage_chart <- ggplot(years_coverage_df, 
  aes(y = reorder(country, coverage))) +
  geom_segment(
    data = subset(years_coverage_df, !is.na(oldest_year) & !is.na(latest_year)),
    aes(x = oldest_year, xend = latest_year),
    linewidth = 6,
    color = '#4682C8'
  ) + 
  geom_text(
    aes(
       x = ifelse(is.na(oldest_year), 1960, oldest_year),
      label = coverage_text,
      fontface = ifelse(coverage_text == "NA", "italic", "plain")
    ),
    hjust = ifelse(is.na(years_coverage_df$oldest_year), -0.1, 1.2),
    size = 8
  ) + 
  labs(
    x = 'Years Covered',
    y = ''
  ) + 
  scale_x_continuous(
    limits = c(1960, 2026),
    breaks = seq(1960, 2025, 10),
    expand = c(0, 0)
  ) +
  theme_minimal() +
  theme(
    panel.grid.major.y = element_blank(),
    axis.text.y = element_text(size = 20, face = 'bold'),
    axis.text.x = element_text(size = 15, angle = 45, hjust = 1, face = 'bold'), 
    axis.title.x = element_text(size= 20, face = 'bold')
  )

years_coverage_chart

# Save chart
ggsave(
  filename = file.path(fig_output_dir, "years_coverage.png"),
  plot = years_coverage_chart,
  width = 10,
  height = 12,
  dpi = 300
)
```
