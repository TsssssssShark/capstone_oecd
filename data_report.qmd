---
title: "Data Report"
date: today
author: Yichu Li
format: 
   pdf:
    toc: true
    number-sections: true
    text: |
        \usepackage{colortbl}
        \usepackage{xcolor}
        \usepackage{booktabs}
        \usepackage{makecell}
        \usepackage{url}
        \usepackage[hypthens]{xurl}
        \def\UrlBreaks{\do\/\do-\do_\do.\do=\do?\do&}
        \def\UrlNoBreaks{\do:\do/\do/}
execute:
  echo: false
  warning: true
  message: false
  cache: false
---

## Script Info

**Project:** OECD National Evaluation Portal\
**Purpose:** (1) To explore 2023 Survey Responses on central web portal, (2) to present findings in the portal assessment table.

```{r}
#| label: setup-packages
#| include: false

# Check and install required packages
required_packages <- c(
  'tidyverse',
  'jsonlite',
  'kableExtra',
  'here',
  'glue',
  'officer',
  'flextable',
  'gt',
  'ggplot2',
  'introdataviz',
  'ggpubr'
)

missing_packages <- required_packages[
  !required_packages %in% rownames(installed.packages())
]

if (length(missing_packages) > 0) {
  message(
    "Installing missing packages:",
    paste(missing_packages, collapse = ", "),
    "\n"
  )
  install.packages(missing_packages)
}

lapply(required_packages, library, character.only = TRUE)

message('All packages loaded successfully!')
```

## Input Data Sets

```{r}
#| label: setup-directories

# Input
original_data = here::here('survey_2023.csv')
portals_information = here::here('portals_information.csv')
gov_expenditure = here::here('oecd_gov_expenditure.csv')

# Output
js_output_dir = here::here('map', 'js', 'data')
fig_output_dir = here::here('fig')
table_output_dir = here::here('tab')
fig_png_output_dir = here::here('fig_png')

message(basename(original_data))
message(basename(portals_information))
```

```{r}
#| label: data-load
#| include: false

survey_2023 <- read_csv(original_data)

new_data <- read_csv(
  portals_information,
  na = c("", "NA", "n/a", "N/A", "null", "#N/A")
)

expenditure <- read_csv(gov_expenditure)


```

\newpage

## 2023 Survey Data Exploration

```{r}
#| label: data-exploration

survey_2023 %>%
  summarise_all(~paste(unique(na.omit(.)), collapse = ", ")) %>%
  pivot_longer(everything(), names_to = "Column", values_to = "Unique_Values") %>%
  mutate(
    Count = sapply(str_split(Unique_Values, ", "), length),
    Unique_Values = str_trunc(Unique_Values, 50)  # cut short
  ) %>%
  kable(caption = "Unique Values per Column")
```

### Re-format Data

Only keep relevant columns for 2023 survey

```{r}
#| label: data-reformat-original
#| eval: true

# Rename and keep relavant columns
survey_2023 <- survey_2023 %>%
  select(
    country = `Reference area`,
    survey_question = Measure,
    survey_answer = OBS_VALUE
  )
  
survey_2023 %>%
  summarise_all(~paste(unique(na.omit(.)), collapse = ", ")) %>%
  pivot_longer(everything(), names_to = "Column", values_to = "Unique_Values") %>%
  mutate(
    Count = sapply(str_split(Unique_Values, ", "), length),
    Unique_Values = str_trunc(Unique_Values, 50)  # cut short
  ) %>%
  kable(caption = "Unique Values per Column")
```

\newpage

## Accessibility:

### Update on Central Web Portal Status

```{r}
#| label: new-data-pivot-longer

new_data <- new_data %>%
  select(-'...33')

new_data_long <- new_data %>%
  pivot_longer(
    cols = -1,
    names_to = 'country',
    values_to = 'survey_answer'
  ) %>%
  rename(survey_question = 1) %>%
  filter(!is.na(country))

# Display new list of countries
unique_new_countries <- unique(new_data_long$country)

# Add row numbers for grouping
data.frame(
  country = unique_new_countries,
  row = rep(1:ceiling(length(unique_new_countries)/4), each = 4)[1:length(unique_new_countries)],
  col = rep(1:4, times = ceiling(length(unique_new_countries)/4))[1:length(unique_new_countries)]
) %>%
  pivot_wider(
    names_from = col,
    values_from = country,
    names_prefix = "Col_"
  ) %>%
  select(-row) %>%
  kable(
    format = "latex",
    booktabs = TRUE,
    caption = "New Country List",
    col.names = rep("", 4),
    align = rep("l", 4)
  ) %>%
  kable_styling(
    latex_options = "hold_position",
    full_width = FALSE
  ) %>%
  column_spec(1:4, width = "3.5cm")
```

\newpage

#### How does the 2023 survey response compare to our updated information?

```{r}
#| label: q-34


survey_2023_q34 <- survey_2023 %>%
  filter(
    survey_question == '34. Is there a central web portal where government evaluations are published?'
    ) %>%
      arrange(country) %>%
      select(country, original_answer = survey_answer)

new_data_q34 <- new_data_long %>%
  filter(grepl('Central portal', survey_question)) %>%
  arrange(country) %>%
  select(country, update_answer = survey_answer)

# Comparative Display
comparison <- full_join(survey_2023_q34, new_data_q34, by = 'country') %>%
  mutate(
    # Replace NA
    original_str = replace_na(original_answer, "NA"),
    update_str = case_when(
      grepl('yes', tolower(update_answer)) ~ 'Yes',
      TRUE ~ 'No'
    ),
   
    # Comparison 
    status = case_when(
      original_str == "NA" ~ 'new_countries',
      
      grepl('development', tolower(original_str)) &
        !grepl('yes', tolower(update_str)) ~ 'development',
      
      grepl('no|development', tolower(original_str)) &
        grepl('yes', tolower(update_str)) ~ 'developed',
      
      grepl('yes', tolower(original_str)) &
        grepl('no', tolower(update_str)) ~ 'removed',
      
      TRUE ~ 'unchanged'
    )
  )

# Different color
comparison_table <- comparison %>%
  select(country, original_str, update_str) %>%
  kable(
    format = "latex",
    booktabs = TRUE,
    caption = "Central Portal Status Comparison",
    label = 'portal_comparison_table',
    col.names = c("Country", "2023 survey", "Update")
  ) %>%
  row_spec(
    which(comparison$status == 'developed'),
    background = "blue!20" 
  ) %>%
  row_spec(
    which(comparison$status == 'removed'),
    background = 'red!20'
  ) %>% 
  row_spec(
    which(comparison$status == 'development'),
    background = 'orange!20'
  ) %>%
  row_spec(
    which(comparison$status == 'new_countries'),
    background = 'green!20'
  )

# Show and Export table
comparison_table

if (dir.exists(table_output_dir)) {
  writeLines(as.character(comparison_table), 
   file.path(table_output_dir, "portal_comparison_table.tex"))
  
} else {
  stop(glue('Directory not found: {table_output_dir}'))
}
```

\newpage

#### Re-format update data on [central portal]{.underline}

Correct the status for Hungary to 'developing'

```{r}
#| label: central-portal-status

# Correct status for Hungary and Lithunia
new_data_q34 <- new_data_q34 %>%
  mutate(
    update_answer = case_when(
      country == 'Hungary' ~ 'under development',
      TRUE ~ update_answer
    )
  )

# Denote status to all countries
central_portal_status <- new_data_q34 %>%
  mutate(
    portal_status = case_when(
      # Convert to lowercase and check for patterns
      grepl("yes", tolower(trimws(update_answer))) ~ "yes",
     grepl("no", tolower(trimws(update_answer))) & 
        !grepl("under development|in development", tolower(update_answer)) ~ "no",
      grepl("under development|in development|currently under", 
            tolower(update_answer)) ~ "developing",
      is.na(update_answer) ~ "developing",
      TRUE ~ "other"
    )
  ) %>%
  select(country, portal_status)
```

```{r}
#| label: function-split-table

create_split_table <- function(data,
                              value_col = "status",
                              group_col = "country", 
                              color_map = NULL,
                              caption = "Two Column Table",
                              col_names = c("Country", "Status", "Country", "Status"),
                              col_widths = c("4cm", "2.5cm", "4cm", "2.5cm"),
                              export_tex = FALSE,
                              tex_filename = NULL,
                              tex_label = NULL) {
  
  # Split data into two columns
  n_rows <- nrow(data)
  split_point <- ceiling(n_rows / 2)
  
  # Create left and right columns
  left_col <- data[1:split_point, ]
  
  # Handle right column
  if(split_point < n_rows) {
    right_col <- data[(split_point + 1):n_rows, ]
  } else {
    right_col <- data.frame(
      matrix("", nrow = 0, ncol = ncol(data))
    )
    names(right_col) <- names(data)
  }
  
  # Pad right column with empty rows if needed
  if (nrow(right_col) < nrow(left_col)) {
    padding_rows <- nrow(left_col) - nrow(right_col)
    padding <- data.frame(
      matrix("", nrow = padding_rows, ncol = ncol(data))
    )
    names(padding) <- names(data)
    right_col <- bind_rows(right_col, padding)
  }
  
  # Apply LaTeX color formatting if color_map provided
  if (!is.null(color_map)) {
    # Apply LaTeX color formatting to left column
    left_col_formatted <- left_col %>%
      mutate(
        !!value_col := ifelse(
          .data[[value_col]] == "",
          "",
          cell_spec(
            .data[[value_col]],
            format = "latex",
            background = ifelse(
              .data[[value_col]] %in% names(color_map),
              color_map[.data[[value_col]]],
              "white"
            )
          )
        )
      )
    
    # Apply LaTeX color formatting to right column
    right_col_formatted <- right_col %>%
      mutate(
        !!value_col := ifelse(
          .data[[value_col]] == "",
          "",
          cell_spec(
            .data[[value_col]],
            format = "latex",
            background = ifelse(
              .data[[value_col]] %in% names(color_map),
              color_map[.data[[value_col]]],
              "white"
            )
          )
        )
      )
  } else {
    left_col_formatted <- left_col
    right_col_formatted <- right_col
  }
  
  # Combine into single table
  two_col_table <- bind_cols(
    left_col_formatted,
    right_col_formatted %>% 
      setNames(paste0(names(right_col_formatted), "2"))
  )
  
  # Create kable table
  result <- two_col_table %>%
    kable(
      format = "latex",
      booktabs = TRUE,
      caption = caption,
      label = tex_label,
      col.names = col_names,
      escape = FALSE
    ) %>%
    kable_styling(
      latex_options = c("hold_position"),
      full_width = FALSE,
      position = "center"
    ) %>%
    column_spec(2, border_right = TRUE)
  
  # Apply column widths
  for(i in 1:length(col_widths)) {
    result <- result %>% column_spec(i, width = col_widths[i])
  }
  
  # Export to .tex file
  if (export_tex && !is.null(tex_filename)) {
    if (!exists("table_output_dir")) {
      stop("table_output_dir undefined!")
    }
    
    tex_path <- file.path(table_output_dir, tex_filename)
    
    writeLines(as.character(result), tex_path)
  }
  
  return(result)
}
```

```{r}
#| label: central-portal-table

portal_table <- create_split_table(
  data = central_portal_status,
  value_col = "portal_status",
  group_col = "country",
  color_map = c(
    "yes" = "blue!20", 
    "no" = "red!20",
    "developing" = "gray!20"
  ),
  caption = "Updated Portal Status",
  export_tex = TRUE,
  tex_filename = 'portal_table.tex',
  tex_label = 'portal_table'
)

portal_table
```

```{r}
#| label: export-portal-js
#| eval: true

tryCatch({
map_data <- central_portal_status %>%
  mutate(
    color = case_when(
      portal_status == "yes" ~ "#5cb85c",     
      portal_status == "no" ~ "#dc3545",      
      portal_status == "developing" ~ "#ffc107",
      TRUE ~ "#6c757d"                    
    ),
    label = case_when(
      portal_status == "yes" ~ "Yes",
      portal_status == "no" ~ "No",
      portal_status == "developing" ~ "Under Development",
      TRUE ~ "No Data"
    )
  )

# Generate JS with additional properties
js_content <- paste0(
  "// Portal status with map styling\n",
  "// Generated: ", Sys.Date(), "\n\n",
  "const PORTAL_DATA = ",
  jsonlite::toJSON(map_data, pretty = TRUE, auto_unbox = TRUE),
  ";\n\n",
  "// Color mapping for legend\n",
  "const STATUS_COLORS = {\n",
  "  'yes': '#28a745',\n",
  "  'no': '#dc3545',\n",
  "  'developing': '#ffc107',\n",
  "  'other': '#6c757d'\n",
  "};\n\n",
  "// Export\n",
  "if (typeof module !== 'undefined' && module.exports) {\n",
  "  module.exports = { PORTAL_MAP_DATA, STATUS_COLORS };\n",
  "}"
)

if (dir.exists(js_output_dir)) {
  writeLines(js_content, file.path(js_output_dir, "portalData.js"))
} else {
  stop(glue('JavaScript output directory not found: {js_output_dir}'))
}

}, error = function(e) {
  message('Error in JavaScript export: ', e$message)
  print(e)
})
```

```{r}
#| label: function-export-js

export_to_js <- function(data, 
                         value_col,
                         js_var_name,
                         filename,
                         color_mapping = NULL,
                         label_mapping = NULL,
                         data_type_name = NULL) {
  
  # Default color mapping if not provided
  if (is.null(color_mapping)) {
    color_mapping <- list(
      "yes" = "#5cb85c",
      "no" = "#dc3545",
      "NA" = "#6c757d"
    )
  }
  
  # Default label mapping if not provided
  if (is.null(label_mapping)) {
    label_mapping <- list(
      "yes" = "Yes",
      "no" = "No",
      "NA" = "No Data"
    )
  }
  
  # Prepare data
  map_data <- data %>%
    mutate(
      value = .data[[value_col]],
      color = case_when(
        value == "yes" ~ color_mapping$yes,
        value == "no" ~ color_mapping$no,
        value == "NA" ~ color_mapping$`NA`,
        TRUE ~ "#6c757d"
      ),
      label = case_when(
        value == "yes" ~ label_mapping$yes,
        value == "no" ~ label_mapping$no,
        value == "NA" ~ label_mapping$`NA`,
        TRUE ~ "Unknown"
      )
    )
  
  # Add data type if provided
  if (!is.null(data_type_name)) {
    map_data <- map_data %>%
      mutate(data_type = data_type_name)
  }
  
  # Generate JS content
  js_content <- paste0(
    "// ", gsub("_", " ", toupper(data_type_name)), "\n",
    "// Generated: ", Sys.Date(), "\n\n",
    "const ", js_var_name, " = ",
    jsonlite::toJSON(map_data, pretty = TRUE, auto_unbox = TRUE),
    ";\n"
  )
  
  # Write to file
  if (dir.exists(js_output_dir)) {
    writeLines(js_content, file.path(js_output_dir, paste0(filename, ".js")))
  } else {
    stop(glue('JavaScript output directory not found: {js_output_dir}'))
  }
}
```

\newpage

### Independent website or a sub-tab of another website?

```{r}
#| label: independent-website-table

# Create df
independent_website_df <- new_data_long %>%
  filter(grepl('Independent website', survey_question)) %>%
  mutate(
    independent_website = case_when(
      grepl("yes", tolower(trimws(survey_answer))) ~ "yes",
      grepl('no', tolower(trimws(survey_answer))) ~ 'no',
      TRUE ~ 'NA'
    )
  ) %>%
  select(country, independent_website) %>%
  arrange(country)

# Creat table
independent_website_table <- create_split_table(
  data = independent_website_df,
  value_col = "independent_website",
  group_col = "country",
  color_map = c(
    "yes" = "blue!20", 
    "no" = "red!20"
  ),
  caption = "Independent Portal?",
  export_tex = TRUE,
  tex_filename = 'independent_website_table.tex',
  tex_label = 'independent_website_table'
)

independent_website_table
```

```{r}
#| label: export-independent-js

export_to_js(
  data = independent_website_df,
  value_col = "independent_website",
  js_var_name = "INDEPENDENT_WEBSITE_DATA",
  filename = "independentWebsiteData",
  color_mapping = list(
    "yes" = "#5cb85c",
    "no" = "#dc3545",
    "NA" = "#6c757d"
  ),
  data_type_name = "independent_website"
)
```

\newpage

### Search Function

```{r}
#| label: search-function-table

# Create df
search_function_df <- new_data_long %>%
  filter(grepl('Search function', survey_question)) %>%
  mutate(
    search_function = case_when(
      grepl("yes", tolower(trimws(survey_answer))) ~ "yes",
      grepl('no', tolower(trimws(survey_answer))) ~ 'no',
      TRUE ~ 'NA'
    )
  ) %>%
  select(country, search_function) %>%
  arrange(country)

# Create table
search_function_table <- create_split_table(
  data = search_function_df,
  value_col = "search_function",
  group_col = "country",
  color_map = c(
    "yes" = "blue!20", 
    "no" = "red!20"
  ),
  caption = "Search Function?",
  export_tex = TRUE,
  tex_filename = 'search_function_table.tex',
  tex_label = 'search_function_table'
)

search_function_table
```

```{r}
#| label: export-search-js

export_to_js(
  data = search_function_df,
  value_col = "search_function",
  js_var_name = "SEARCH_FUNCTION_DATA",
  filename = "searchFunctionData",
  color_mapping = list(
    "yes" = "#5cb85c",
    "no" = "#dc3545",
    "NA" = "#6c757d"
  ),
  data_type_name = "independent_website"
)
```

\newpage

### Policy Area Categorisation?

```{r}
#| label: policy-categorisation-table

# Create df
policy_categorisation_df <- new_data_long %>%
  filter(grepl('Policy area categorisation', survey_question)) %>%
  mutate(
    policy_categorisation = case_when(
      grepl("yes", tolower(trimws(survey_answer))) ~ "yes",
      grepl('no', tolower(trimws(survey_answer))) ~ 'no',
      TRUE ~ 'NA'
    )
  ) %>%
  select(country, policy_categorisation) %>%
  arrange(country)

# Creat table
policy_categorisation_table <- create_split_table(
  data = policy_categorisation_df,
  value_col = "policy_categorisation",
  group_col = "country",
  color_map = c(
    "yes" = "blue!20", 
    "no" = "red!20"
  ),
  caption = "Policy Area Categorisation?",
  export_tex = TRUE,
  tex_filename = 'policy_categorisation_table.tex',
  tex_label = 'policy_categorisation_table'
)

policy_categorisation_table
```

```{r}
#| label: export-policy-categorisation-js

export_to_js(
  data = policy_categorisation_df,
  value_col = "policy_categorisation",
  js_var_name = "POLICY_CATEGORISATION_DATA",
  filename = "policyCategorisationData",
  color_mapping = list(
    "yes" = "#5cb85c",
    "no" = "#dc3545",
    "NA" = "#6c757d"
  ),
  data_type_name = "policy_categorisation"
)
```

\newpage

### Summary Available on the Portal?

```{r}
#| label: summary-available-table


# Create df
summary_available_df <- new_data_long %>%
  filter(grepl('Summary available', survey_question)) %>%
  mutate(
    summary_available = case_when(
      grepl("yes", tolower(trimws(survey_answer))) ~ "yes",
      grepl('no', tolower(trimws(survey_answer))) ~ 'no',
      TRUE ~ 'NA'
    )
  ) %>%
  select(country, summary_available) %>%
  arrange(country)

# Creat table
summary_available_table <- create_split_table(
  data = summary_available_df,
  value_col = "summary_available",
  group_col = "country",
  color_map = c(
    "yes" = "blue!20", 
    "no" = "red!20"
  ),
  caption = "Summary Available on the Portal",
  export_tex = TRUE,
  tex_filename = 'summary_available_table.tex',
  tex_label = 'summary_available_table'
)

summary_available_table
```

```{r}
#| label: export-summary-available-js

export_to_js(
  data = summary_available_df,
  value_col = "summary_available",
  js_var_name = "SUMMARY_AVAILABLE_DATA",
  filename = "summaryAvailableData",
  color_mapping = list(
    "yes" = "#5cb85c",
    "no" = "#dc3545",
    "NA" = "#6c757d"
  ),
  data_type_name = "summary_available"
)
```

\newpage

### Accessibility Tools

```{r}
#| label: accessibility-tools-table

# Create df
accessibility_tools_df <- new_data_long %>%
  filter(grepl('Accessibility tools', survey_question, ignore.case = FALSE)) %>%
  mutate(
    accessibility_tools = case_when(
      grepl("yes", tolower(trimws(survey_answer))) ~ "yes",
      grepl('no', tolower(trimws(survey_answer))) ~ 'no',
      TRUE ~ 'NA'
    )
  ) %>%
  select(country, accessibility_tools) %>%
  arrange(country)

# Create table
accessibility_tools_table <- create_split_table(
  data = accessibility_tools_df,
  value_col = "accessibility_tools",
  group_col = "country",
  color_map = c(
    "yes" = "blue!20", 
    "no" = "red!20"
  ),
  caption = "Accessibility Tools?",
  export_tex = TRUE,
  tex_filename = 'accessibility_tools_table.tex',
  tex_label = 'accessibility_tools_table'
)

accessibility_tools_table
```

```{r}
#| label: export-accessibility-tools-js

export_to_js(
  data = accessibility_tools_df,
  value_col = "accessibility_tools",
  js_var_name = "ACCESSIBILITY_TOOLS_DATA",
  filename = "accessibilityToolsData",
  color_mapping = list(
    "yes" = "#5cb85c",
    "no" = "#dc3545",
    "NA" = "#6c757d"
  ),
  data_type_name = "accessibility_tools"
)
```

\newpage

### Visual Presentation

```{r}
#| label: visual-presentation-table

# Create df
visual_presentation_df <- new_data_long %>%
  filter(grepl('Visual presentation', survey_question)) %>%
  mutate(
    visual_presentation = case_when(
      grepl("yes", tolower(trimws(survey_answer))) ~ "yes",
      grepl('no', tolower(trimws(survey_answer))) ~ 'no',
      TRUE ~ 'NA'
    )
  ) %>%
  select(country, visual_presentation) %>%
  arrange(country)

# Create table
visual_presentation_table <- create_split_table(
  data = visual_presentation_df,
  value_col = "visual_presentation",
  group_col = "country",
  color_map = c(
    "yes" = "blue!20", 
    "no" = "red!20"
  ),
  caption = "Visual Presentation?",
  export_tex = TRUE,
  tex_filename = 'visual_presentation_table.tex',
  tex_label = 'visual_presentation_table'
)

visual_presentation_table
```

\newpage

### Comfortable Font

```{r}
#| label: comfortable-font-table
#| eval: false

# Create df
comfortable_font_df <- new_data_long %>%
  filter(grepl('Comfortable font', survey_question)) %>%
  mutate(
    comfortable_font = case_when(
      grepl("yes", tolower(trimws(survey_answer))) ~ "yes",
      grepl('no', tolower(trimws(survey_answer))) ~ 'no',
      TRUE ~ 'NA'
    )
  ) %>%
  select(country, comfortable_font) %>%
  arrange(country)

# Create table
comfortable_font_table <- create_split_table(
  data = comfortable_font_df,
  value_col = "comfortable_font",
  group_col = "country",
  color_map = c(
    "yes" = "blue!20", 
    "no" = "red!20"
  ),
  caption = "Comfortable Font?",
  export_tex = TRUE,
  tex_filename = 'comfortable_font_table.tex',
  tex_label = 'comfortable_font_table'
)

comfortable_font_table
```

\newpage

### Interactive Tools

```{r}
#| label: interactive-tools-table

# Create df
interactive_tools_df <- new_data_long %>%
  filter(grepl('Interactive tools', survey_question, ignore.case = FALSE)) %>%
  mutate(
    interactive_tools = case_when(
      grepl("yes", tolower(trimws(survey_answer))) ~ "yes",
      grepl('no', tolower(trimws(survey_answer))) ~ 'no',
      TRUE ~ 'NA'
    )
  ) %>%
  select(country, interactive_tools) %>%
  arrange(country)

# Create table
interactive_tools_table <- create_split_table(
  data = interactive_tools_df,
  value_col = "interactive_tools",
  group_col = "country",
  color_map = c(
    "yes" = "blue!20", 
    "no" = "red!20"
  ),
  caption = "Interactive Tools?",
  export_tex = TRUE,
  tex_filename = 'interactive_tools_table.tex',
  tex_label = 'interactive_tools_table'
)

interactive_tools_table
```

### Full Table

```{r}
#| label: accessibility-table

accessibility_table_df <- reduce(
  list(
    central_portal_status, 
    search_function_df, 
    policy_categorisation_df,
    summary_available_df,
    accessibility_tools_df
  ),
  full_join, by = 'country'
) %>%
  
  mutate(
    across(
      -country,
      ~ ifelse(. == 'yes', "$\\times$", "$\\cdot$")
    )
  )

accessibility_table <- kable(
  accessibility_table_df,
  format = 'latex',
  booktabs = TRUE, 
  escape = FALSE,
  caption = 'Accessibility Features',
  label = 'accessibility_table',
  col.names = c(
    "Country",
  "\\makecell{Central\\\\Portal}",
  "\\makecell{Search\\\\Function}",
  "\\makecell{Policy\\\\Categorisation}",
  "\\makecell{Summary\\\\Available}",
  "\\makecell{Accessibility\\\\Tools}"
  )
)%>%
    kable_styling(
    latex_options = c("scale_down", "hold_position")
  )


accessibility_table

writeLines(
  as.character(accessibility_table),
  file.path(table_output_dir, 'accessibility_table.tex')
)
```

```{r}
#| label: accessibility-table-png

accessibility_table_df <- reduce(
  list(
    central_portal_status, 
    search_function_df, 
    policy_categorisation_df,
    summary_available_df,
    accessibility_tools_df
  ),
  full_join, by = 'country'
) %>%
  mutate(
    across(
      -country,
      ~ ifelse(. == 'yes', "X", "·")
    )
  ) %>%
  arrange(country)

# Split into two halves
n_rows <- nrow(accessibility_table_df)
split_point <- ceiling(n_rows / 2)

df_part1 <- accessibility_table_df[1:split_point, ]
df_part2 <- accessibility_table_df[(split_point + 1):n_rows, ]

# Function to create gt table
create_accessibility_gt <- function(data, title_suffix = "") {
  data %>%
    gt() %>%
    tab_header(
      title = paste("Accessibility Features", title_suffix)
    ) %>%
    cols_label(
      country = "Country",
      portal_status = "Central Portal",
      search_function = "Search Function",
      policy_categorisation = "Policy Categorisation",
      summary_available = "Summary Available",
      accessibility_tools = "Accessibility Tools"
    ) %>%
    tab_style(
      style = cell_text(align = "center"),
      locations = cells_body(columns = -country)
    ) %>%
    tab_style(
      style = cell_text(weight = "bold"),
      locations = cells_column_labels()
    )
}

# Create two tables
accessibility_gt_1 <- create_accessibility_gt(df_part1, "(A-I)" )
accessibility_gt_2 <- create_accessibility_gt(df_part2, "(J-U)")

# Display
accessibility_gt_1
accessibility_gt_2

# Save as PNG
gtsave(
  accessibility_gt_1,
  filename = file.path(fig_png_output_dir, "accessibility_table_1.png"),
  vwidth = 800,
  vheight = 800
)

gtsave(
  accessibility_gt_2,
  filename = file.path(fig_png_output_dir, "accessibility_table_2.png"),
  vwidth = 800,
  vheight = 800
)
```

\newpage

## Comprehensiveness:

### COFOG Categories (10) Coverage

```{r}
#| label: cofog-data

cofog <- new_data_long %>%
  filter(survey_question == '1.5 Number of COFOG categories covered') %>%
  arrange(country) %>%
  select(country, coverage = survey_answer) %>%
  mutate(
    coverage = parse_number(coverage)
  )
```

```{r}
#| label: cofog-table
#| eval: false

cofog_table <- create_split_table(
  data = cofog,
  value_col = "coverage",
  group_col = "country",
  caption = "Number of COFOG categories covered",
  export_tex = TRUE,
  tex_filename = 'cofog_table.tex',
  tex_label = 'cofog_table'
)

cofog_table
```

```{r}
#| label: cofog-bar
#| fig-cap: 'COFOG Coverage by Country'
#| fig-width: 15
#| fig-height: 16

# Merge with central portal status and add asterisk
cofog_bar_data <- cofog %>%
  left_join(central_portal_status, by = 'country') %>%
  mutate(
    coverage_raw = coverage,
    coverage = replace_na(coverage_raw, 0),
    label_text = ifelse(is.na(coverage_raw), 'NA', as.character(coverage)),
    # Add asterisk for countries without central portal
    country_label = ifelse(portal_status != 'yes' | is.na(portal_status), 
                           paste0(country, '*'), 
                           country)
  ) %>%
  arrange(desc(coverage), country)

# Horizontal pie chart
cofog_bar_chart <- ggplot(cofog_bar_data, aes(x = coverage, 
                                              y = reorder(country_label, -coverage))) +
  geom_bar(stat = "identity", fill = "#4682C8", width = 0.6, linewidth = 0.2) +
  geom_text(
    aes(label = label_text),
    hjust = -0.2,
    size = 8,
    fontface = ifelse(cofog_bar_data$label_text == "NA", "italic", "plain") 
  ) +  
  scale_x_continuous(
    limits = c(0, 11),
    breaks = seq(0, 10, 2),
    expand = c(0, 0)
  ) +
  labs(
    x = "Number of COFOG Categories Covered (out of 10)",
    y = "",
    caption = '* No central evaluation portal'
  ) +
  theme_minimal() +
  theme(
    panel.grid.major.y = element_blank(),
    panel.grid.minor.x = element_blank(),
    axis.text.y = element_text(size = 20),
    axis.text.x = element_text(size = 20),
    axis.title.x = element_text(size = 20),
    plot.caption = element_text(size = 14, hjust = 0, face = "italic")
  )

cofog_bar_chart

# Save chart
ggsave(
  filename = file.path(fig_output_dir, "cofog_bar.pdf"),
  plot = cofog_bar_chart,
  width = 10,
  height = 12
)

ggsave(
  filename = file.path(fig_png_output_dir, "cofog_bar.png"),
  plot = cofog_bar_chart,
  width = 10,
  height = 12,
  dpi = 300
)
```

\newpage

### Years Coverage

```{r}
#| label: years-coverage-data

oldest_year_df <- new_data_long %>%
  filter(survey_question == '1.1 Oldest year') %>%
  select(country, oldest_year = survey_answer)

latest_year_df <- new_data_long %>%
  filter(survey_question == '1.2 Latest year') %>%
  select(country, latest_year = survey_answer)

years_coverage_df <- oldest_year_df %>%
  left_join(latest_year_df, by = 'country') %>%
  left_join(central_portal_status, by = 'country') %>%  # 加入 portal 状态
  mutate(
    oldest_year = as.numeric(oldest_year),
    latest_year = as.numeric(latest_year),
    coverage = as.numeric(latest_year - oldest_year),
    coverage_text = ifelse(is.na(coverage), 'NA', as.character(coverage)),
    # Flag *
    country_label = ifelse(portal_status != 'yes' | is.na(portal_status), 
                           paste0(country, '*'), 
                           country)
  )
```

```{r}
#| label: years-coverage-chart
#| fig-cap: 'Years Coverage by Country'
#| fig-width: 15
#| fig-height: 16

years_coverage_chart <- ggplot(years_coverage_df, 
  aes(y = reorder(country_label, -coverage))) +
  geom_segment(
    data = subset(years_coverage_df, !is.na(oldest_year) & !is.na(latest_year)),
    aes(x = oldest_year, xend = latest_year),
    linewidth = 6,
    color = '#4682C8'
  ) + 
  geom_text(
    aes(
      x = ifelse(is.na(oldest_year), 1960, oldest_year),
      label = coverage_text,
      fontface = ifelse(coverage_text == "NA", "italic", "plain")
    ),
    hjust = ifelse(is.na(years_coverage_df$oldest_year), -0.1, 1.2),
    size = 8
  ) + 
  labs(
    x = 'Years',
    y = '',
    caption = '* No central evaluation portal'
  ) + 
  scale_x_continuous(
    limits = c(1955, 2026),
    breaks = seq(1955, 2025, 10),
    expand = c(0, 0)
  ) +
  theme_minimal() +
  theme(
    panel.grid.major.y = element_blank(),
    axis.text.y = element_text(size = 20),
    axis.text.x = element_text(size = 15, angle = 45, hjust = 1), 
    axis.title.x = element_text(size = 20),
    plot.caption = element_text(size = 14, hjust = 0, face = "italic")
  )

years_coverage_chart

# Save chart
ggsave(
  filename = file.path(fig_output_dir, "years_coverage.pdf"),
  plot = years_coverage_chart,
  width = 10,
  height = 12
)

ggsave(
  filename = file.path(fig_png_output_dir, "years_coverage.png"),
  plot = years_coverage_chart,
  width = 10,
  height = 12,
  dpi = 300
)
```

### Volume

```{r}
#| label: volume-chart
#| fig-cap: 'Volume'
#| fig-width: 15
#| fig-height: 16

# Get countries with uncertain volume
uncertain_countries <- new_data_long %>%
  filter(survey_question == '1.4.1 Uncertain number') %>%
  filter(!is.na(survey_answer)) %>%
  pull(country)

volume <- new_data_long %>%
  filter(grepl('Volume of evaluations', survey_question, ignore.case = FALSE)) %>%
  left_join(central_portal_status, by = 'country') %>%
  mutate(
    volume = as.numeric(survey_answer),
    # Flag * for no portal, + for uncertain
    country_label = case_when(
      country %in% uncertain_countries & (portal_status != 'yes' | is.na(portal_status)) ~ paste0(country, '*+'),
      country %in% uncertain_countries ~ paste0(country, '+'),
      portal_status != 'yes' | is.na(portal_status) ~ paste0(country, '*'),
      TRUE ~ country
    )
  )

# Horizontal bar chart
volume_chart <- ggplot(volume, aes(x = volume, 
                                   y = reorder(country_label, -volume, na.rm = TRUE))) +
  
  geom_bar(
    data = filter(volume, !is.na(volume)),
    stat = "identity", 
    fill = "#4682C8", 
    width = 0.6, 
    linewidth = 0.2
  ) +
  geom_text(
    aes(x = ifelse(is.na(volume), 0.02, volume + 0.02),
        label = ifelse(is.na(volume), "NA", volume),
        fontface = ifelse(is.na(volume), "italic", "plain")),
    hjust = 0,
    size = 8
  ) +  
  scale_x_continuous(
    limits = c(0, 7000),  
    breaks = seq(0, 7000, 500),
    expand = c(0, 500) 
  ) +
  labs(
    x = "Volume",
    y = "",
    caption = '* No central evaluation portal\n+ Estimated'
  ) +
  theme_minimal() +
  theme(
    panel.grid.major.y = element_blank(),
    panel.grid.minor.x = element_blank(),
    axis.text.y = element_text(size = 20, face = 'bold'),
    axis.text.x = element_text(size = 20, face = 'bold'),
    axis.title.x = element_text(size = 20, face = 'bold', hjust = 0.5),
    plot.caption = element_text(size = 14, hjust = 0, face = "italic")
  )

volume_chart

# Save chart
ggsave(
  filename = file.path(fig_output_dir, "volume.pdf"),
  plot = volume_chart,
  width = 20,
  height = 22
)

ggsave(
  filename = file.path(fig_png_output_dir, "volume.png"),
  plot = volume_chart,
  width = 20,
  height = 22,
  dpi = 300
)
```

## Index and Trends

### Accessibility

```{r}
#| label: index-accessibility
#| fig-cap: 'Accessibility Index'
#| fig-width: 15
#| fig-height: 16

accessibility_index <- reduce(
  list(
    central_portal_status, 
    search_function_df, 
    policy_categorisation_df,
    summary_available_df,
    accessibility_tools_df
  ),
  full_join, by = 'country'
) %>%
  
  # Turn into binary 1/0
  mutate(across(
    -country,
    ~ case_when(
      . == "yes" ~ 1,
      . == "no"  ~ 0,
      TRUE       ~ NA_real_
    )
  )) %>%
  
  # Obtain index
  rowwise() %>% 
  mutate(accessibility_index = mean(c_across(-country))) %>% 
  ungroup() %>%
  
  # Flag *
  mutate(
    country_label = ifelse(portal_status != 1 | is.na(portal_status), 
                           paste0(country, '*'), 
                           country)
  )

# Horizontal bar chart
accessibility_index_chart <- ggplot(accessibility_index, 
                                    aes(x = accessibility_index, 
                                        y = reorder(country_label,
                                          -accessibility_index, na.rm = TRUE))) +
  
  geom_bar(
    data = filter(accessibility_index, !is.na(accessibility_index)),
    stat = "identity", 
    fill = "#F05F00", 
    width = 0.6, 
    linewidth = 0.2
  ) +
  geom_text(
    aes(x = ifelse(is.na(accessibility_index), 0.02, accessibility_index + 0.02),
        label = ifelse(is.na(accessibility_index), 
                       "NA", round(accessibility_index, 2)),
        fontface = ifelse(is.na(accessibility_index), "italic", "plain")),
    hjust = 0,
    size = 8
  ) +  
  scale_x_continuous(
    limits = c(0, 1.1),  
    breaks = seq(0, 1, 0.2),
    expand = c(0, 0.02) 
  ) +
  labs(
    x = "Accessibility Index",
    y = "",
    caption = '* No central evaluation portal'
  ) +
  theme_minimal() +
  theme(
    panel.grid.major.y = element_blank(),
    panel.grid.minor.x = element_blank(),
    axis.text.y = element_text(size = 20),
    axis.text.x = element_text(size = 20),
    axis.title.x = element_text(size = 20, hjust = 0.5),
    plot.caption = element_text(size = 14, hjust = 0, face = "italic")
  )

accessibility_index_chart

# Save chart
ggsave(
  filename = file.path(fig_output_dir, "accessibility_index_chart.pdf"),
  plot = accessibility_index_chart,
  width = 10,
  height = 12
)

ggsave(
  filename = file.path(fig_png_output_dir, "accessibility_index_chart.png"),
  plot = accessibility_index_chart,
  width = 10,
  height = 12,
  dpi = 300
)
```

### Comprehensiveness

```{r}
#| label: function-minmax

normalise_01 <- normalize_01 <- function(x) {
  x <- as.numeric(x)
  (x - min(x, na.rm = TRUE)) / (max(x, na.rm = TRUE) - min(x, na.rm = TRUE))
}
```

```{r}
#| label: index-comprehensiveness
#| fig-cap: 'Comprehensiveness Index'
#| fig-width: 15
#| fig-height: 16

cofog <- cofog %>%
  mutate(cofog_index = normalise_01(coverage))

years_coverage_df <- years_coverage_df %>%
  mutate(years_index = normalise_01(coverage))

volume <- volume %>%
  mutate(volume_index = normalise_01(log(volume + 1))) %>%
  select(-survey_question, -survey_answer)

comprehensiveness_index <- reduce(
  list(
    cofog %>% select(country, cofog_index),
    years_coverage_df %>% select(country, years_index),
    volume %>% select(country, volume_index)
  ),
  full_join, by = 'country'
) %>% 
  
  rowwise() %>% 
  mutate(comprehensiveness_index = mean(c_across(-country))) %>% 
  ungroup() %>%
  
  # Flag * and +
  left_join(central_portal_status, by = 'country') %>%
  mutate(
    country_label = case_when(
      country %in% uncertain_countries & (portal_status != 'yes' | is.na(portal_status)) ~ paste0(country, '*+'),
      country %in% uncertain_countries ~ paste0(country, '+'),
      portal_status != 'yes' | is.na(portal_status) ~ paste0(country, '*'),
      TRUE ~ country
    )
  )
  
# Horizontal bar chart
comprehensiveness_index_chart <- ggplot(comprehensiveness_index, 
                                        aes(x = comprehensiveness_index, 
                                            y = reorder(country_label,
                                              -comprehensiveness_index, na.rm = TRUE))) +
  
  geom_bar(
    data = filter(comprehensiveness_index, !is.na(comprehensiveness_index)),
    stat = "identity", 
    fill = "#4682C8", 
    width = 0.6, 
    linewidth = 0.2
  ) +
  geom_text(
    aes(x = ifelse(is.na(comprehensiveness_index), 0.02, comprehensiveness_index + 0.02),
        label = ifelse(is.na(comprehensiveness_index), 
                       "NA", round(comprehensiveness_index, 2)),
        fontface = ifelse(is.na(comprehensiveness_index), "italic", "plain")),
    hjust = 0,
    size = 8
  ) +  
  scale_x_continuous(
    limits = c(0, 1),  
    breaks = seq(0, 1, 0.2),
    expand = c(0, 0.02) 
  ) +
  labs(
    x = "Comprehensiveness Index",
    y = "",
    caption = '* No central evaluation portal\n+ Estimated volume number'
  ) +
  theme_minimal() +
  theme(
    panel.grid.major.y = element_blank(),
    panel.grid.minor.x = element_blank(),
    axis.text.y = element_text(size = 20),
    axis.text.x = element_text(size = 20),
    axis.title.x = element_text(size = 20, hjust = 0.5),
    plot.caption = element_text(size = 14, hjust = 0, face = "italic")
  )

comprehensiveness_index_chart

# Save chart
ggsave(
  filename = file.path(fig_output_dir, "comprehensiveness_index_chart.pdf"),
  plot = comprehensiveness_index_chart,
  width = 10,
  height = 12
)

ggsave(
  filename = file.path(fig_png_output_dir, "comprehensiveness_index_chart.png"),
  plot = comprehensiveness_index_chart,
  width = 10,
  height = 12,
  dpi = 300
)
```

### Overall Index

```{r}
#| label: index-overall
#| fig-cap: 'Overall Index'
#| fig-width: 15
#| fig-height: 16

index_overall <- accessibility_index %>% 
  select(country, accessibility_index) %>%
  full_join(
    comprehensiveness_index %>% select(country, comprehensiveness_index),
    by = 'country'
  ) %>%
  
  rowwise() %>% 
  mutate(index_overall = mean(c_across(-country))) %>% 
  ungroup() %>%
  
  # Flag * and +
  left_join(central_portal_status, by = 'country') %>%
  mutate(
    country_label = case_when(
      country %in% uncertain_countries & (portal_status != 'yes' | is.na(portal_status)) ~ paste0(country, '*+'),
      country %in% uncertain_countries ~ paste0(country, '+'),
      portal_status != 'yes' | is.na(portal_status) ~ paste0(country, '*'),
      TRUE ~ country
    ),
    # Calculate contribution (each contributes half to the mean)
    accessibility_contrib = accessibility_index / 2,
    comprehensiveness_contrib = comprehensiveness_index / 2,
    # Flag if either component is NA
    has_complete_data = !is.na(accessibility_contrib) & !is.na(comprehensiveness_contrib)
  )

# Reshape to long format for stacked bar
index_overall_long <- index_overall %>%
  filter(has_complete_data) %>%
  select(country_label, index_overall, accessibility_contrib, comprehensiveness_contrib) %>%
  pivot_longer(
    cols = c(accessibility_contrib, comprehensiveness_contrib),
    names_to = "component",
    values_to = "contribution"
  ) %>%
  mutate(
    component = case_when(
      component == "accessibility_contrib" ~ "Accessibility",
      component == "comprehensiveness_contrib" ~ "Comprehensiveness"
    )
  )

# Stacked bar chart
index_overall_chart <- ggplot(index_overall_long, 
                              aes(x = contribution, 
                                  y = reorder(country_label, -index_overall, na.rm = TRUE),
                                  fill = component)) +
  
  geom_bar(
    stat = "identity",
    width = 0.6,
    position = position_stack(reverse = TRUE)
  ) +
  
  # Add total label at the end of bar 
  geom_text(
    data = index_overall,
    aes(x = ifelse(is.na(index_overall), 0.02, index_overall + 0.02),
        y = reorder(country_label, -index_overall, na.rm = TRUE),
        label = ifelse(is.na(index_overall), "NA", round(index_overall, 2)),
        fontface = ifelse(is.na(index_overall), "italic", "plain")),
    hjust = 0,
    size = 8,
    inherit.aes = FALSE
  ) +
  
  scale_fill_manual(
    values = c("Accessibility" = "#F05F00", "Comprehensiveness" = "#4682C8"),
    name = "Component"
  ) +
  scale_x_continuous(
    limits = c(0, 1),  
    breaks = seq(0, 1, 0.2),
    expand = c(0, 0.02) 
  ) +
  labs(
    x = "Overall Index",
    y = "",
    caption = '* No central evaluation portal\n+ Estimated volume number'
  ) +
  theme_minimal() +
  theme(
    panel.grid.major.y = element_blank(),
    panel.grid.minor.x = element_blank(),
    axis.text.y = element_text(size = 20),
    axis.text.x = element_text(size = 20),
    axis.title.x = element_text(size = 20, hjust = 0.5),
    plot.caption = element_text(size = 14, hjust = 0, face = "italic"),
    legend.position = "bottom",
    legend.text = element_text(size = 20),
    legend.title = element_text(size = 20)
  )

index_overall_chart

# Save chart
ggsave(
  filename = file.path(fig_output_dir, "index_overall_chart.pdf"),
  plot = index_overall_chart,
  width = 10,
  height = 12
)

ggsave(
  filename = file.path(fig_png_output_dir, "index_overall_chart.png"),
  plot = index_overall_chart,
  width = 10,
  height = 12,
  dpi = 300
)
```

### Accessibility & Independent Portal

```{r}
#| label: accessibility-independent-plot
#| fig-height: 6
#| fig-cap: 'Accessibility Index by Portal Independence'

features_independent_df <- independent_website_df %>%
  full_join(
    accessibility_index %>% select(country, accessibility_index),
    by = 'country'
  ) %>%
  mutate(
    independent_website_label = case_when(
      independent_website == "yes" ~ "Yes",
      independent_website == "no" ~ "No",
      TRUE ~ NA_character_
    )
  )

# Filter NA
features_independent_nona <- features_independent_df %>%
  filter(!is.na(independent_website) & !is.na(accessibility_index))

# Calculate means for each group
means_df <- features_independent_nona %>%
  group_by(independent_website) %>%
  summarise(
    mean_value = mean(accessibility_index, na.rm = TRUE),
    .groups = 'drop'
  )

# Violin Plot
features_independent_plot <- ggplot(features_independent_nona, 
                                    aes(x = 1, y = accessibility_index, 
                                        fill = independent_website)) +
  geom_split_violin(trim = TRUE, alpha = 0.8) +
  
  # Add mean labels only using annotate
  annotate(
    "text",
    x = 0.75,
    y = means_df$mean_value[means_df$independent_website == "no"],
    label = paste0("Mean: ", round(means_df$mean_value[means_df$independent_website == "no"], 2)),
    size = 4,
    hjust = 1
  ) +
  annotate(
    "text",
    x = 1.40,
    y = means_df$mean_value[means_df$independent_website == "yes"],
    label = paste0("Mean: ", round(means_df$mean_value[means_df$independent_website == "yes"], 2)),
    size = 4,
    hjust = 0
  ) +
  
  scale_fill_manual(
    values = c("yes" = "#4682C8", "no" = "#F05F00"),
    labels = c("yes" = "Yes", "no" = "No")
  ) +
  scale_x_continuous(breaks = 1, labels = "", limits = c(0.5, 1.5)) +
  labs(y = "Accessibility Index",
       x = "",
       fill = "Independent Website") +
  theme_minimal()

features_independent_plot

ggsave("fig/features_independent_plot.pdf", 
       plot = features_independent_plot,
       width = 6.5, height = 6)

ggsave("fig_png/features_independent_plot.png", 
       plot = features_independent_plot,
       width = 6.5, height = 6, dpi = 300)
```

\newpage

### Overall Index by Central Portal Status

```{r}
#| label: index-central-plot
#| fig-height: 6
#| fig-cap: Overall Index by Central Portal Status

# Create accessibility index WITHOUT central portal (to avoid circularity)
accessibility_index_no_portal <- reduce(
  list(
    search_function_df, 
    policy_categorisation_df,
    summary_available_df,
    accessibility_tools_df
  ),
  full_join, by = 'country'
) %>%
  
  # Convert to binary 1/0
  mutate(across(
    -country,
    ~ case_when(
      . == "yes" ~ 1,
      . == "no"  ~ 0,
      TRUE       ~ NA_real_
    )
  )) %>%
  
  # Calculate mean of 4 indicators (excluding central portal)
  rowwise() %>% 
  mutate(accessibility_index_no_portal = mean(c_across(-country), na.rm = TRUE)) %>% 
  ungroup()

# Create overall index WITHOUT central portal
index_overall_no_portal <- accessibility_index_no_portal %>% 
  select(country, accessibility_index_no_portal) %>%
  full_join(
    comprehensiveness_index %>% select(country, comprehensiveness_index),
    by = 'country'
  ) %>%
  
  rowwise() %>% 
  mutate(index_overall_no_portal = mean(c_across(-country), na.rm = TRUE)) %>% 
  ungroup()

# Merge with portal status for comparison
index_central_df <- index_overall_no_portal %>%
  left_join(central_portal_status, by = 'country') %>%
  mutate(
    has_portal = ifelse(portal_status == 'yes', 'Yes', 'No')
  )

# Remove NA
index_portal_df <- index_central_df %>%
  filter(!is.na(has_portal) & !is.na(index_overall_no_portal))

# Violin Plot: compare overall index by portal status
index_portal_plot <- ggplot(index_portal_df, 
                            aes(x = 1, y = index_overall_no_portal, 
                                fill = has_portal)) +
  geom_split_violin(trim = TRUE, alpha = 0.8) +
  scale_fill_manual(values = c("Yes" = "#4682C8", "No" = "#F05F00")) +
  scale_x_continuous(breaks = 1, labels = "") +
  labs(y = "Overall Index (excl. Central Portal)",
       x = "Density",
       fill = "Central Portal") +
  theme_minimal()

index_portal_plot

ggsave("fig/index_portal_plot.pdf", 
       plot = index_portal_plot,
       width = 6.5, height = 6)

ggsave("fig_png/index_portal_plot.png", 
       plot = index_portal_plot,
       width = 6.5, height = 6, dpi = 300)
```

\newpage

### Portal Index & Government Expenditure –\> not significant

```{r}
#| label: index-expenditure-plot
#| fig-height: 4
#| eval: TRUE

expenditure_clean <- expenditure %>%
  select(
    country = `Reference area`,
    unit_measure = UNIT_MEASURE,
    year = TIME_PERIOD,
    unit = `Unit multiplier`,
    expenditure = OBS_VALUE
  ) %>%
  
  mutate(
    expenditure_PPP = ifelse(
      unit_measure == 'USD_PPP',
      expenditure/1000,
      NA
    ),
    
    expenditure_pGDP = ifelse(
      unit_measure == 'PT_B1GQ',
      expenditure,
      NA
    )
  ) %>%
  
group_by(country) %>%
  mutate(
    mean_PPP = if(any(!is.na(expenditure_PPP))) {
      mean(expenditure_PPP, na.rm = TRUE)
    } else {
      NA_real_
    },
    
    mean_pGDP = if(any(!is.na(expenditure_pGDP))) {
      mean(expenditure_pGDP, na.rm = TRUE)
    } else {
      NA_real_
    }
  ) %>%
  ungroup()

index_expenditure <- expenditure_clean %>%
  full_join(index_overall, by = 'country') 

index_expenditure_PPP_df <- index_expenditure %>%
  distinct(country, mean_PPP, index_overall, .keep_all = TRUE) %>%
  filter(!is.na(mean_PPP) & !is.na(index_overall))

index_expenditure_pGDP_df <- index_expenditure %>%
  distinct(country, mean_pGDP, index_overall, .keep_all = TRUE) %>%
  filter(!is.na(mean_pGDP) & !is.na(index_overall))
  
# Plot with gov expenditure
index_expenditure_PPP_chart <- ggplot(index_expenditure_PPP_df, 
                                      aes(x = mean_PPP, y = index_overall)) +
  geom_point(alpha = 0.7, color = '#4682C8') +
  geom_smooth(method = 'lm', se = TRUE, color = "#F05F00") +
  
  labs(
    x = 'Average Government Expenditure 2022-2024 (Billion USD PPP)',
    y = 'Overall Index'
  ) + 
  
  theme_minimal() +
  theme(panel.grid.major = element_blank())

index_expenditure_PPP_chart

ggsave(
  filename = file.path(fig_output_dir, "index_expenditure_PPP_chart.pdf"),
  plot = index_expenditure_PPP_chart,
  height = 5
)

ggsave(
  filename = file.path(fig_png_output_dir, "index_expenditure_PPP_chart.png"),
  plot = index_expenditure_PPP_chart,
  height = 5,
  dpi = 300
)

# Log gov expenditure
index_expenditure_PPP_chart_log <- ggplot(index_expenditure_PPP_df, 
                                      aes(x = log(mean_PPP), y = index_overall)) +
  geom_point(alpha = 0.7, color = '#4682C8') +
  geom_smooth(method = 'lm', se = TRUE, color = "#F05F00") +
  
  labs(
    x = 'Log average Government Expenditure 2022-2024 (Billion USD PPP)',
    y = 'Overall Index'
  ) + 
  
  theme_minimal() +
  theme(panel.grid.major = element_blank())

index_expenditure_PPP_chart_log

ggsave(
  filename = file.path(fig_output_dir, "index_expenditure_PPP_chart_log.pdf"),
  plot = index_expenditure_PPP_chart_log,
  height = 5
)

ggsave(
  filename = file.path(fig_png_output_dir, "index_expenditure_PPP_chart_log.png"),
  plot = index_expenditure_PPP_chart_log,
  height = 5,
  dpi = 300
)

# Expenditure pGDP

index_expenditure_pGDP_chart <- ggplot(index_expenditure_pGDP_df, 
                                      aes(x = mean_pGDP, y = index_overall)) +
  geom_point(alpha = 0.7, color = '#4682C8') +
  geom_smooth(method = 'lm', se = TRUE, color = "#F05F00") +
  
  labs(
    x = 'Average Government Expenditure 2022-2024 (% of GDP)',
    y = 'Overall Index'
  ) + 
  
  theme_minimal() +
  theme(panel.grid.major = element_blank())

index_expenditure_pGDP_chart

ggsave(
  filename = file.path(fig_output_dir, "index_expenditure_pGDP_chart.pdf"),
  plot = index_expenditure_pGDP_chart,
  height = 5
)

ggsave(
  filename = file.path(fig_png_output_dir, "index_expenditure_pGDP_chart.png"),
  plot = index_expenditure_pGDP_chart,
  height = 5,
  dpi = 300
)

```

## Country-hyperlink table

```{r}
#| label: hyperlink-table

hyperlink_df <- new_data_long %>%
  filter(survey_question == 'Hyperlink') %>%
  select(country, hyperlink = survey_answer) %>%
  arrange(country) %>%
  # Handle multiple URLs separated by ; or ;
  mutate(
  hyperlink = sapply(hyperlink, function(x) {
    if (is.na(x) || x == "") return(x)
    urls <- trimws(unlist(strsplit(x, "\\s*[;；]\\s*")))
    urls_wrapped <- paste0("\\url{", urls, "}")
    paste(urls_wrapped, collapse = " \\newline ")
  })
)

# Split into two halves
n_rows <- nrow(hyperlink_df)
split_point <- ceiling(n_rows / 2)

left_col <- hyperlink_df[1:split_point, ]
right_col <- hyperlink_df[(split_point + 1):n_rows, ]

# Pad right column if needed
if (nrow(right_col) < nrow(left_col)) {
  padding <- data.frame(country = "", hyperlink = "")
  right_col <- bind_rows(right_col, padding)
}

# Combine
two_col_table <- bind_cols(
  left_col,
  right_col %>% setNames(c("country2", "hyperlink2"))
)

# Create table with text wrapping
hyperlink_table <- two_col_table %>%
  kable(
    format = "latex",
    booktabs = TRUE,
    caption = "Portal Hyperlinks",
    label = "hyperlink_table",
    col.names = c("Country", "Hyperlink", "Country", "Hyperlink"),
    escape = FALSE
  ) %>%
  kable_styling(
    latex_options = c("hold_position"),
    full_width = FALSE,
    font_size = 8
  ) %>%
  column_spec(1, width = "2cm") %>%
  column_spec(2, width = "6cm") %>%
  column_spec(3, width = "2cm", border_left = TRUE) %>%
  column_spec(4, width = "6cm")

hyperlink_table

# Export
writeLines(as.character(hyperlink_table), 
           file.path(table_output_dir, "hyperlink_table.tex"))
```
