---
title: "Data Report"
date: today
author: Yichu Li
format: 
   pdf:
    toc: true
    number-sections: true
execute:
  echo: false
  warning: true
  message: false
  cache: false
---

## Script Info

**Project:** OECD National Evaluation Portal\
**Purpose:** (1) To explore 2023 Survey Responses on central web portal, (2) to present findings in the portal assessment table.

```{r}
#| label: setup-packages
#| include: false

# Check and install required packages
required_packages <- c(
  'tidyverse',
  'jsonlite',
  'kableExtra',
  'here',
  'glue',
  'officer',
  'flextable',
  'gt',
  'ggplot2'
)

missing_packages <- required_packages[
  !required_packages %in% rownames(installed.packages())
]

if (length(missing_packages) > 0) {
  message(
    "Installing missing packages:",
    paste(missing_packages, collapse = ", "),
    "\n"
  )
  install.packages(missing_packages)
}

lapply(required_packages, library, character.only = TRUE)

message('All packages loaded successfully!')
```

## Input Data Sets

```{r}
#| label: setup-directories

# Input
original_data = here::here('OECD.GOV.GIP,DSD_QDD_GOV_PE@DF_GOV_PE,+all.csv')
portal_assessment = here::here('portal_assessment.csv')

# Output
js_output_dir = here::here('map', 'js')
fig_output_dir = here::here('fig')

message(basename(original_data))
message(basename(portal_assessment))
```

```{r}
#| label: data-load
#| include: false

df <- read_csv(original_data)

new_data <- read_csv(portal_assessment)


```

\newpage

## 2023 Survey Data Exploration

```{r}
#| label: data-exploration

df %>%
  summarise_all(~paste(unique(na.omit(.)), collapse = ", ")) %>%
  pivot_longer(everything(), names_to = "Column", values_to = "Unique_Values") %>%
  mutate(
    Count = sapply(str_split(Unique_Values, ", "), length),
    Unique_Values = str_trunc(Unique_Values, 50)  # cut short
  ) %>%
  kable(caption = "Unique Values per Column")
```

### Re-format Data

Only keep relevant columns for 2023 survey

```{r}
#| label: data-reformat-original
#| eval: true

# Rename and keep relavant columns
df <- df %>%
  select(
    country = `Reference area`,
    survey_question = Measure,
    survey_answer = OBS_VALUE
  )
  
df %>%
  summarise_all(~paste(unique(na.omit(.)), collapse = ", ")) %>%
  pivot_longer(everything(), names_to = "Column", values_to = "Unique_Values") %>%
  mutate(
    Count = sapply(str_split(Unique_Values, ", "), length),
    Unique_Values = str_trunc(Unique_Values, 50)  # cut short
  ) %>%
  kable(caption = "Unique Values per Column")
```

\newpage

## Portal Assessment Table Findings:

### Update on Central Web Portal Status

```{r}
#| label: new-data-pivot-longer

new_data <- new_data %>%
  select(-'...33')

new_data_long <- new_data %>%
  pivot_longer(
    cols = -1,
    names_to = 'country',
    values_to = 'survey_answer'
  ) %>%
  rename(survey_question = 1) %>%
  filter(!is.na(country))

# Display new list of countries
unique_new_countries <- unique(new_data_long$country)

# Add row numbers for grouping
data.frame(
  country = unique_new_countries,
  row = rep(1:ceiling(length(unique_new_countries)/4), each = 4)[1:length(unique_new_countries)],
  col = rep(1:4, times = ceiling(length(unique_new_countries)/4))[1:length(unique_new_countries)]
) %>%
  pivot_wider(
    names_from = col,
    values_from = country,
    names_prefix = "Col_"
  ) %>%
  select(-row) %>%
  kable(
    format = "latex",
    booktabs = TRUE,
    caption = "New Country List",
    col.names = rep("", 4),
    align = rep("l", 4)
  ) %>%
  kable_styling(
    latex_options = "hold_position",
    full_width = FALSE
  ) %>%
  column_spec(1:4, width = "3.5cm")
```

\newpage

#### How does the 2023 survey response compare to our updated information?

```{r}
#| label: q-34

df_q34 <- df %>%
  filter(
    survey_question == '34. Is there a central web portal where government evaluations are published?'
    ) %>%
      arrange(country) %>%
      select(country, original_answer = survey_answer)

new_data_q34 <- new_data_long %>%
  filter(survey_question == '3.12 Central portal exists') %>%
  arrange(country) %>%
  select(country, update_answer = survey_answer)

# Comparative Display
comparison <- full_join(df_q34, new_data_q34, by = 'country') %>%
  mutate(
    # Ignore capital but treat NA as value
    changed = case_when(
      is.na(original_answer) & is.na(update_answer) ~ FALSE,
      is.na(original_answer) | is.na(update_answer) ~ TRUE, 
      TRUE ~ tolower(original_answer) != tolower(update_answer)
    )
  )

# Different color
comparison %>%
  select(-changed) %>%
  kable(
    format = "latex",
    booktabs = TRUE,
    caption = "Central Portal Exists?",
    col.names = c("Country", "2023 survey", "Update")
  ) %>%
  kable_styling(
    latex_options = c("scale_down", "hold_position")
  ) %>%
  row_spec(
    which(comparison$changed),
    background = "red!20" 
  )
```

```{r}
#| label: export-q34-comparison-png
#| eval: true

# Export to .png
ft_q34 <- comparison %>%
  select(country, original_answer, update_answer) %>%
  flextable() %>%
  
  # Set column headers
  set_header_labels(
    country = "Country",
    original_answer = "2023 Survey",
    update_answer = "Update"
  ) %>%
  
  # Highlight changed rows
  bg(i = which(comparison$changed), 
     bg = "#4682C8") %>% 
  
   # Increase font size for all cells
  fontsize(size = 12, part = "all") %>%
  
  # Make header bold and larger
  bold(part = "header") %>%
  
  # Auto-adjust column widths
  autofit() %>%
  
  # Add outer border
  border_outer(border = fp_border(color = "black"))

# Save as image
if (dir.exists (fig_output_dir)){
  invisible(
    save_as_image(
      ft_q34, path = glue("{fig_output_dir}/portal_status_comparison.png"), res = 300
      )
    )
} else {
  stop(glue('Directory not found: {fig_output_dir}'))
}

```

\newpage

#### Re-format update data on [central portal]{.underline}

Correct the status for Hungary to 'developing'

```{r}
#| label: central-portal-status

# Correct status for Hungary and Lithunia
new_data_q34 <- new_data_q34 %>%
  mutate(
    update_answer = case_when(
      country == 'Hungary' ~ 'under development',
      TRUE ~ update_answer
    )
  )

# Denote status to all countries
central_portal_status <- new_data_q34 %>%
  mutate(
    portal_status = case_when(
      # Convert to lowercase and check for patterns
      grepl("yes", tolower(trimws(update_answer))) ~ "yes",
     grepl("no", tolower(trimws(update_answer))) & 
        !grepl("under development|in development", tolower(update_answer)) ~ "no",
      grepl("under development|in development|currently under", 
            tolower(update_answer)) ~ "developing",
      is.na(update_answer) ~ "developing",
      TRUE ~ "other"
    )
  ) %>%
  select(country, portal_status)
```

```{r}
#| label: function-split-table

create_split_table <- function(data,
                              value_col = "status",
                              group_col = "country", 
                              color_map = NULL,
                              caption = "Two Column Table",
                              col_names = c("Country", "Status", "Country", "Status"),
                              col_widths = c("4cm", "2.5cm", "4cm", "2.5cm"),
                              export_png = FALSE,  
                              png_path = NULL,     
                              png_colors = NULL,   
                              png_res = 300) {     
  
  
  # Split data into two columns
  n_rows <- nrow(data)
  split_point <- ceiling(n_rows / 2)
  
  # Create left and right columns
  left_col <- data[1:split_point, ]
  
  # Handle right column
  if(split_point < n_rows) {
    right_col <- data[(split_point + 1):n_rows, ]
  } else {
    right_col <- data.frame(
      matrix("", nrow = 0, ncol = ncol(data))
    )
    names(right_col) <- names(data)
  }
  
  # Pad right column with empty rows if needed
  if (nrow(right_col) < nrow(left_col)) {
    padding_rows <- nrow(left_col) - nrow(right_col)
    padding <- data.frame(
      matrix("", nrow = padding_rows, ncol = ncol(data))
    )
    names(padding) <- names(data)
    right_col <- bind_rows(right_col, padding)
  }
  
  # Export PNG if requested (before LaTeX formatting)
  if (export_png && !is.null(png_path)) {
    require(flextable)
    require(officer)
    
    # Create two-column display for PNG
    two_col_display <- bind_cols(
      left_col,
      right_col %>% setNames(paste0(names(right_col), "2"))
    )
    
    header_labels <- setNames(
      col_names,
      c(group_col, value_col, paste0(group_col, "2"), paste0(value_col, "2"))
    )
    
    # Create flextable
    ft <- two_col_display %>% flextable()
    
    ft <- do.call(set_header_labels, c(list(ft), header_labels))
    
    ft <- ft %>%
      bold(part = "header") %>%
      align(align = "center", j = c(2, 4), part = "all") %>%
      align(align = "left", j = c(1, 3), part = "all") %>%
      border_inner_v(border = fp_border(color = "gray", width = 1)) %>%
      border_outer(border = fp_border(color = "black", width = 2)) %>%
      width(j = c(1, 3), width = 2.5) %>%
      width(j = c(2, 4), width = 1.2) %>%
      fontsize(size = 11, part = "all") %>%
      font(fontname = "Arial", part = "all")
    
    # Apply PNG colors if provided
    if (!is.null(png_colors)) {
      for (status in names(png_colors)) {
        # Left column colors
        rows_left <- which(left_col[[value_col]] == status)
        if (length(rows_left) > 0) {
          ft <- ft %>% bg(i = rows_left, j = 2, bg = png_colors[status])
        }
        
        # Right column colors
        rows_right <- which(right_col[[value_col]] == status)
        if (length(rows_right) > 0) {
          ft <- ft %>% bg(i = rows_right, j = 4, bg = png_colors[status])
        }
      }
      
      # White text for dark colors (customize based on your colors)
      dark_statuses <- c("yes", "no")
      ft <- ft %>%
        color(i = which(left_col[[value_col]] %in% dark_statuses), 
              j = 2, color = "white") %>%
        color(i = which(right_col[[value_col]] %in% dark_statuses), 
              j = 4, color = "white")
    }
    
    # Save PNG
    save_as_image(ft, path = png_path, res = png_res)
  }
  
  # Continue with LaTeX table formatting
  if (!is.null(color_map)) {
    # Apply LaTeX color formatting to left column
    left_col_formatted <- left_col %>%
      mutate(
        !!value_col := ifelse(
          .data[[value_col]] == "",
          "",
          cell_spec(
            .data[[value_col]],
            format = "latex",
            background = ifelse(
              .data[[value_col]] %in% names(color_map),
              color_map[.data[[value_col]]],
              "white"
            )
          )
        )
      )
    
    # Apply LaTeX color formatting to right column
    right_col_formatted <- right_col %>%
      mutate(
        !!value_col := ifelse(
          .data[[value_col]] == "",
          "",
          cell_spec(
            .data[[value_col]],
            format = "latex",
            background = ifelse(
              .data[[value_col]] %in% names(color_map),
              color_map[.data[[value_col]]],
              "white"
            )
          )
        )
      )
  } else {
    left_col_formatted <- left_col
    right_col_formatted <- right_col
  }
  
  # Combine into single table
  two_col_table <- bind_cols(
    left_col_formatted,
    right_col_formatted %>% 
      setNames(paste0(names(right_col_formatted), "2"))
  )
  
  # Create kable table
  result <- two_col_table %>%
    kable(
      format = "latex",
      booktabs = TRUE,
      caption = caption,
      col.names = col_names,
      escape = FALSE
    ) %>%
    kable_styling(
      latex_options = c("hold_position"),
      full_width = FALSE,
      position = "center"
    ) %>%
    column_spec(2, border_right = TRUE)
  
  # Apply column widths
  for(i in 1:length(col_widths)) {
    result <- result %>% column_spec(i, width = col_widths[i])
  }
  
  return(result)
}
```

```{r}
#| label: central-portal-table

portal_table <- create_split_table(
  data = central_portal_status,
  value_col = "portal_status",
  group_col = "country",
  color_map = c(
    "yes" = "blue!20", 
    "no" = "red!20",
    "developing" = "gray!20"
  ),
  caption = "Updated Portal Status",
  # PNG export options
  export_png = TRUE,
  png_path = file.path(fig_output_dir, "portal_status_table.png"),
  png_colors = c(
    "yes" = "#4682C8",
    "no" = "#FF8C00",
    "developing" = "grey"
  ),
  png_res = 300
)

portal_table
```

```{r}
#| label: export-portal-js

tryCatch({
map_data <- central_portal_status %>%
  mutate(
    color = case_when(
      portal_status == "yes" ~ "#5cb85c",     
      portal_status == "no" ~ "#dc3545",      
      portal_status == "developing" ~ "#ffc107",
      TRUE ~ "#6c757d"                    
    ),
    label = case_when(
      portal_status == "yes" ~ "Has Portal",
      portal_status == "no" ~ "No Portal",
      portal_status == "developing" ~ "Under Development",
      TRUE ~ "Unknown"
    )
  )

# Generate JS with additional properties
js_content <- paste0(
  "// Portal status with map styling\n",
  "// Generated: ", Sys.Date(), "\n\n",
  "const PORTAL_MAP_DATA = ",
  jsonlite::toJSON(map_data, pretty = TRUE, auto_unbox = TRUE),
  ";\n\n",
  "// Color mapping for legend\n",
  "const STATUS_COLORS = {\n",
  "  'yes': '#28a745',\n",
  "  'no': '#dc3545',\n",
  "  'developing': '#ffc107',\n",
  "  'other': '#6c757d'\n",
  "};\n\n",
  "// Export\n",
  "if (typeof module !== 'undefined' && module.exports) {\n",
  "  module.exports = { PORTAL_MAP_DATA, STATUS_COLORS };\n",
  "}"
)

if (dir.exists(js_output_dir)) {
  writeLines(js_content, file.path(js_output_dir, "portalMapData.js"))
} else {
  stop(glue('JavaScript output directory not found: {js_output_dir}'))
}

}, error = function(e) {
  message('Error in JavaScript export: ', e$message)
  print(e)
})
```

\newpage

### Independent website or a sub-tab of another website?

```{r}
#| label: independent-website-table

# Create df
independent_website_data <- new_data_long %>%
  filter(survey_question == '3.14 Independent website rather than subtab of another website?') %>%
  mutate(
    independent_website = case_when(
      grepl("yes", tolower(trimws(survey_answer))) ~ "yes",
      grepl('no', tolower(trimws(survey_answer))) ~ 'no',
      TRUE ~ 'NA'
    )
  ) %>%
  select(country, independent_website) %>%
  arrange(country)

# Creat table
independent_website_table <- create_split_table(
  data = independent_website_data,
  value_col = "independent_website",
  group_col = "country",
  color_map = c(
    "yes" = "blue!20", 
    "no" = "red!20"
  ),
  caption = "Indendent Website?",
  # PNG export options
  export_png = TRUE,
  png_path = file.path(fig_output_dir, "independent_website_table.png"),
  png_colors = c(
    "yes" = "#4682C8",
    "no" = "#FF8C00",
    "developing" = "grey"
  ),
  png_res = 300
)

independent_website_table
```

\newpage

### COFOG Categories (10) Coverage

```{r}
#| label: cofog-data

cofog <- new_data_long %>%
  filter(survey_question == '2.1 Number of policy areas covered (out of 10 COFOG categories)') %>%
  arrange(country) %>%
  select(country, coverage = survey_answer) %>%
  mutate(
    coverage = parse_number(coverage)
  )
```

```{r}
#| label: cofog-table
#| eval: false

cofog_table <- create_split_table(
  data = cofog,
  value_col = "coverage",
  group_col = "country",
  caption = "Number of COFOG categories covered",
  
  # PNG export options
  export_png = TRUE,
  png_path = file.path(fig_output_dir, "cofog_table.png"),
  png_res = 300
)

cofog_table
```

```{r}
#| label: cofog-bar
#| fig-cap: 'COFOG COverage by Country'
#| fig-width: 15
#| fig-height: 16

# Prepare data to treat NA
cofog_bar_data <- cofog %>%
  mutate(
    coverage_raw = coverage,
    coverage = replace_na(coverage_raw, 0),
    label_text = ifelse(is.na(coverage_raw), 'NA', as.character(coverage))
  ) %>%
  arrange(desc(coverage), country)

# Horizontal pie chart
cofog_bar_chart <- ggplot(cofog_bar_data, aes(x = coverage, y = reorder(country, coverage))) +
  geom_bar(stat = "identity", fill = "#4682C8", width = 0.6, linewidth = 0.2) +
  geom_text(
    aes(label = label_text),
    hjust = -0.2,
    size = 8,
    fontface = ifelse(cofog_bar_data$label_text == "NA", "italic", "plain") 
  ) +  
  scale_x_continuous(
    limits = c(0, 11),
    breaks = seq(0, 10, 2),
    expand = c(0, 0)
  ) +
  labs(
    x = "Number of COFOG Categories Covered (out of 10)",
    y = ""
  ) +
  theme_minimal() +
  theme(
    panel.grid.major.y = element_blank(),
    panel.grid.minor.x = element_blank(),
    axis.text.y = element_text(size = 20, face = 'bold'),
    axis.text.x = element_text(size = 20, face = 'bold'),
    axis.title.x = element_text(size = 20, face = 'bold')
  )

cofog_bar_chart

# Save chart
ggsave(
  filename = file.path(fig_output_dir, "cofog_bar.png"),
  plot = cofog_bar_chart,
  width = 10,
  height = 12,
  dpi = 300
)
```

\newpage

### Policy Area Categorisation?

```{r}
#| label: policy-categorisation-table

# Create df
policy_categorisation_data <- new_data_long %>%
  filter(survey_question == '3.2 Policy area categorisation') %>%
  mutate(
    policy_categorisation = case_when(
      grepl("yes", tolower(trimws(survey_answer))) ~ "yes",
      grepl('no', tolower(trimws(survey_answer))) ~ 'no',
      TRUE ~ 'NA'
    )
  ) %>%
  select(country, policy_categorisation) %>%
  arrange(country)

# Creat table
policy_categorisation_table <- create_split_table(
  data = policy_categorisation_data,
  value_col = "policy_categorisation",
  group_col = "country",
  color_map = c(
    "yes" = "blue!20", 
    "no" = "red!20"
  ),
  caption = "Policy Area Categorisation",
  
  # PNG export options
  export_png = TRUE,
  png_path = file.path(fig_output_dir, "policy_categorisation_table.png"),
  png_colors = c(
    "yes" = "#4682C8",
    "no" = "#FF8C00"
  ),
  png_res = 300
)

policy_categorisation_table
```

\newpage

### Summary Available on the Portal?

```{r}
#| label: summary-available-table


# Create df
summary_available_data <- new_data_long %>%
  filter(survey_question == '3.11 Summaries available on the portal (not as a part of the main documents)') %>%
  mutate(
    summary_available = case_when(
      grepl("yes", tolower(trimws(survey_answer))) ~ "yes",
      grepl('no', tolower(trimws(survey_answer))) ~ 'no',
      TRUE ~ 'NA'
    )
  ) %>%
  select(country, summary_available) %>%
  arrange(country)

# Creat table
summary_available_table <- create_split_table(
  data = summary_available_data,
  value_col = "summary_available",
  group_col = "country",
  color_map = c(
    "yes" = "blue!20", 
    "no" = "red!20"
  ),
  caption = "Summary Available on the Portal",
  
  # PNG export options
  export_png = TRUE,
  png_path = file.path(fig_output_dir, "summary_available_table.png"),
  png_colors = c(
    "yes" = "#4682C8",
    "no" = "#FF8C00"
  ),
  png_res = 300
)

summary_available_table
```
